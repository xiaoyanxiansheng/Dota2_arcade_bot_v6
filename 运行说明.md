# Dota2 Arcade Bot 运行说明

## 启动模式

### 1. 生产模式（默认）- 进度条显示
```bash
node index.js
```

**特点**：
- **屏蔽所有日志输出**
- **只显示实时进度条**
- 进度条显示：已加入房间的 Bot 数量 / 总 Bot 数量
- 类似文件下载的进度显示
- 适合日常使用和生产环境

**显示示例**：
```
[System] 🚀 Dota2 Arcade Bot 启动 (生产模式)
[System] 车队数量: 1
[System] Bot 总数: 10 (1 Leaders + 9 Followers)
[System] 开始连接 Steam 并创建房间...

[████████████████████░░░░░░░░░░░░░░░░░░░░] 45% | 房间: 3 | Bot: 4/10
```

**进度条说明**：
- `█` = 已加入房间的 Bot
- `░` = 未加入房间的 Bot
- `45%` = 进度百分比
- `房间: 3` = 已创建的房间数量（通过 LobbyID 去重统计）
- `Bot: 4/10` = 已加入房间/总 Bot 数

**实现机制**：
- 进度监控在 Bot 启动 10 秒后开始
- 每秒轮询一次所有 Bot 的状态（`IN_LOBBY` 或 `SEEDING`）
- 通过 `currentLobbyId` 去重统计实际房间数量
- 非侵入式设计，不影响核心业务逻辑
- 达到 100% 后自动停止监控并换行

**注意**：
- 只有错误信息会打印到终端
- 进度条每秒更新一次
- 统计数据来自实际 Bot 状态，准确可靠

---

### 2. 调试模式 - 详细日志
```bash
node index.js debug
```

**特点**：
- 显示所有 GC 消息
- SOCache 数据解析详情
- 成员列表、房间状态等详细信息
- 适合开发调试和问题排查

**日志示例**：
```
[System] 🚀 启动模式: 调试模式 (详细日志)
[leader_account|LEADER] 🔔 [GC重要消息] 24 | state=SEEDING | payload.length=256
[leader_account|LEADER] 📦 [SOCache-24] ===== 收到 CMsgSOCacheSubscribed =====
[leader_account|LEADER] 📦 [SOCache-24] objects.length = 1
[leader_account|LEADER] 📦 [SOCache-24]   [0] typeId=2004, objectData.length=1
[leader_account|LEADER] 📦 [SOCache-24]   🎯 发现 CSODOTALobby 类型!
[leader_account|LEADER] 📦 [SOCache-24[0][0]] ========== Lobby 解析成功 ==========
[leader_account|LEADER] 📦 [SOCache-24[0][0]]   lobbyId: 123456789
[leader_account|LEADER] 📦 [SOCache-24[0][0]]   gameName: "Bot Room test_fleet #1"
[leader_account|LEADER] 📦 [SOCache-24[0][0]]   memberCount: 1
[leader_account|LEADER] 📦 [SOCache-24[0][0]]   👥 房间成员列表 (1人):
[leader_account|LEADER] 📦 [SOCache-24[0][0]]      [0] id=76561198012345678 👈 (我)
```

---

## 配置文件

编辑 `config.json` 来配置账号和参数：

```json
{
  "global_settings": {
    "target_app_id": 570,
    "custom_game_id": "1396649696593898392",
    "server_region": 0,
    "lobby_password": "",
    "max_players_per_room": 4,
    "seeding_mode": true,
    "debug_mode": false,          // 会被命令行参数覆盖
    "debug_max_bots_per_room": 3
  },
  "fleets": [
    {
      "id": "test_fleet",
      "leader": {
        "username": "your_leader_account",
        "password": "your_password",
        "shared_secret": "your_2fa_secret"
      },
      "followers": [
        {
          "username": "follower1",
          "password": "password1",
          "shared_secret": "2fa_secret1"
        }
      ]
    }
  ]
}
```

---

## 常见操作

### 查看实时日志
生产模式已经非常简洁，可以直接查看。如需过滤特定账号的日志：

**Windows PowerShell**:
```powershell
node index.js | Select-String "leader_account"
```

**Linux/Mac**:
```bash
node index.js | grep "leader_account"
```

### 保存日志到文件

**生产模式（进度条）**:
```bash
# 进度条无法保存到文件（使用 \r 覆盖），建议使用调试模式记录日志
node index.js debug > logs/debug.log 2>&1
```

**调试日志**:
```bash
node index.js debug > logs/debug.log 2>&1
```

**提示**：如果需要记录详细日志，请使用调试模式。生产模式的进度条不适合输出到文件。

### 后台运行

**Windows (使用 PM2)**:
```bash
npm install -g pm2
pm2 start index.js --name "dota2-bot"
pm2 start index.js --name "dota2-bot-debug" -- debug
```

**Linux (使用 screen)**:
```bash
screen -S dota2-bot
node index.js
# 按 Ctrl+A, D 脱离 screen
```

---

## 功能对比表

| 功能 | 生产模式 | 调试模式 |
|------|---------|---------|
| 启动信息 | ✅ 简化 | ✅ 详细 |
| **进度条** | ✅ 实时显示 | ❌ 不显示 |
| Steam 登录 | ❌ | ✅ |
| GC 连接 | ❌ | ✅ |
| 房间创建 | ❌ | ✅ |
| 房间加入 | ❌ | ✅ |
| 房间离开 | ❌ | ✅ |
| 成员变化 | ❌ | ✅ |
| 错误信息 | ✅ | ✅ |
| GC 消息 | ❌ | ✅ |
| SOCache 解析 | ❌ | ✅ |
| 成员列表 | ❌ | ✅ |
| LobbyID | ❌ | ✅ |
| FleetManager | ❌ | ✅ |
| ReadyUp 心跳 | ❌ | ✅ |
| 轮询请求 | ❌ | ✅ |

---

## 故障排查

如果遇到问题：

1. **首先使用调试模式运行**：
   ```bash
   node index.js debug > debug.log 2>&1
   ```

2. **检查关键日志**：
   - `Steam 登录成功` - 确认账号登录
   - `GC 连接确认` - 确认游戏协调器连接
   - `房间创建已确认` - 确认房间创建成功
   - `离开确认成功` - 确认 Leader 正确离开旧房间

3. **常见问题**：
   - **房间创建超时**：检查网络连接和 Steam GC 状态
   - **Follower 加入失败**：检查密码配置和 CRC/Timestamp
   - **房间满4人自动开始**：检查 `debug_max_bots_per_room` 是否设置为 3

---

## 性能建议

- **小规模测试（1-5个账号）**：使用调试模式，方便观察
- **中规模运行（5-20个账号）**：使用生产模式，减少日志开销
- **大规模部署（20+账号）**：使用生产模式 + 日志轮转

---

## 生产模式 vs 调试模式对比

### 生产模式（默认）

**显示内容**：
- ✅ 启动信息（车队数量、Bot 总数）
- ✅ **实时进度条**（已加入/总数、百分比、房间数）
- ❌ 错误信息（始终显示）

**不显示内容**：
- ❌ 所有其他日志（Steam 登录、房间创建、加入、离开等）
- ❌ 内部状态更新
- ❌ GC 消息
- ❌ 调试信息

**适用场景**：
- 日常运行
- 生产环境
- 多车队大规模部署
- 需要清爽界面

### 调试模式

**显示内容**：
- ✅ 所有日志信息
- ✅ Steam 登录/GC 连接
- ✅ 房间创建/加入/离开
- ✅ SOCache 消息解析
- ✅ 成员列表详情
- ✅ 内部状态更新

**适用场景**：
- 开发调试
- 问题排查
- 学习系统工作原理

---

## 更新日志

- **2025-01-XX v2**: 实现进度条显示模式
  - 🎨 生产模式完全屏蔽日志，改为实时进度条显示
  - 📊 进度条显示：已加入 Bot 数/总数、百分比、房间数
  - 🚀 类似文件下载的优雅显示方式
  - ⚡ 500ms 限流，避免过度刷新
  - ❌ 错误信息始终显示（换行后打印）

- **2025-01-XX v1**: 进一步简化生产模式日志
  - 生产模式只显示房间相关操作（创建/加入/离开/成员变化）
  - 所有内部机制日志（登录/GC连接/轮询/心跳等）移至调试模式
  - 优化日志文案，更加简洁明了

