<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dota 2 Bot æ§åˆ¶å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .log-window {
            height: 500px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
        }
        .log-entry { margin: 2px 0; border-bottom: 1px solid #333; padding: 2px 5px; }
        .log-info { color: #d4d4d4; }
        .log-success { color: #4ade80; }
        .log-warning { color: #facc15; }
        .log-error { color: #f87171; }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }
        
        /* è¿›åº¦æ¡åŠ¨ç”» */
        .progress-bar {
            background: linear-gradient(
                90deg,
                rgba(34, 197, 94, 1) 0%,
                rgba(74, 222, 128, 1) 50%,
                rgba(34, 197, 94, 1) 100%
            );
            background-size: 200% 100%;
            animation: shimmer 2s ease-in-out infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* è¿›åº¦æ¡æ¡çº¹æ•ˆæœ */
        .progress-stripes {
            background-image: linear-gradient(
                45deg,
                rgba(255,255,255,0.15) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255,255,255,0.15) 50%,
                rgba(255,255,255,0.15) 75%,
                transparent 75%,
                transparent
            );
            background-size: 1rem 1rem;
            animation: progress-stripes 1s linear infinite;
        }
        @keyframes progress-stripes {
            from { background-position: 1rem 0; }
            to { background-position: 0 0; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex flex-col overflow-hidden">
    <div id="app" class="flex h-full">
        
        <!-- ä¾§è¾¹æ  -->
        <div class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col">
            <div class="p-4 font-bold text-xl border-b border-gray-700 flex items-center">
                <span class="text-blue-500 mr-2">ğŸ¤–</span> Dota 2 Bot
            </div>
            
            <nav class="flex-1 overflow-y-auto p-2 space-y-2">
                <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">æ§åˆ¶é¢æ¿</div>
                
                <!-- å±•ç¤ºè½¦é˜Ÿ -->
                <div class="bg-gray-700/50 rounded p-3 mb-2">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium">å±•ç¤ºè½¦é˜Ÿ</span>
                        <span :class="status.showcase ? 'bg-green-500' : 'bg-red-500'" class="w-2 h-2 rounded-full"></span>
                    </div>
                    <div class="flex space-x-2 mb-2">
                        <button @click="toggleProcess('showcase', 'start')" :disabled="status.showcase" class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-xs py-1 px-2 rounded transition">å¯åŠ¨</button>
                        <button @click="toggleProcess('showcase', 'stop')" :disabled="!status.showcase" class="flex-1 bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed text-xs py-1 px-2 rounded transition">åœæ­¢</button>
                    </div>
                    <div class="border-t border-gray-600 pt-2 mt-2">
                        <label class="text-xs text-gray-400 block mb-1">å¤§å·éªŒè¯</label>
                        <select v-model="selectedShowcaseLeader" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs mb-1">
                            <option value="">-- é€‰æ‹©è´¦å· --</option>
                            <option v-for="(leader, idx) in showcaseLeaders" :key="idx" :value="leader.username">{{ leader.username }}</option>
                        </select>
                        <button @click="verifyLeader('showcase', selectedShowcaseLeader)" :disabled="!selectedShowcaseLeader || toolStatus.running" class="w-full bg-gray-600 hover:bg-gray-500 disabled:opacity-50 text-xs py-1 rounded">éªŒè¯</button>
                    </div>
                </div>

                <!-- æŒ‚æœºè½¦é˜Ÿ -->
                <div class="bg-gray-700/50 rounded p-3 mb-2">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium">æŒ‚æœºè½¦é˜Ÿ</span>
                        <span :class="status.farming ? 'bg-green-500' : 'bg-red-500'" class="w-2 h-2 rounded-full"></span>
                    </div>
                    <div class="flex space-x-2 mb-2">
                        <button @click="toggleProcess('farming', 'start')" :disabled="status.farming" class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-xs py-1 px-2 rounded transition">å¯åŠ¨</button>
                        <button @click="toggleProcess('farming', 'stop')" :disabled="!status.farming" class="flex-1 bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed text-xs py-1 px-2 rounded transition">åœæ­¢</button>
                    </div>
                    <!-- è¿›åº¦æ˜¾ç¤ºï¼šä»…è¿è¡Œæ—¶æ˜¾ç¤º -->
                    <div v-if="status.farming && farmingProgress" class="border-t border-gray-600 pt-2 mt-2">
                        <!-- å½“å‰é…ç½®åç§° -->
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-blue-400 font-bold">ğŸ“¦ {{ farmingProgress.currentConfig || '-' }}</span>
                            <span class="text-xs text-gray-400">é…ç½® {{ farmingProgress.currentConfigIndex + 1 }}/{{ farmingProgress.totalConfigs }}</span>
                        </div>
                        
                        <!-- è¿›åº¦æ¡ -->
                        <div class="relative h-6 bg-gray-600 rounded-full overflow-hidden mb-2 shadow-inner">
                            <div class="absolute inset-0 progress-bar progress-stripes transition-all duration-500 ease-out rounded-full" 
                                 :style="{ width: farmingProgress.percent + '%' }"></div>
                            <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white" style="text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                                {{ farmingProgress.configProgress }}/{{ farmingProgress.configTotal }} ({{ farmingProgress.percent }}%)
                            </div>
                        </div>
                        
                        <!-- è¯¦ç»†ä¿¡æ¯ -->
                        <div class="grid grid-cols-2 gap-1 text-xs">
                            <div class="flex justify-between text-gray-400"><span>ğŸšª æˆ¿é—´:</span><span class="text-white">{{ farmingProgress.configRooms || 0 }}</span></div>
                            <div class="flex justify-between text-gray-400"><span>â±ï¸ æ—¶é•¿:</span><span class="text-yellow-400 font-bold">{{ formatElapsed(farmingProgress.configElapsed) }}</span></div>
                        </div>
                        
                        <!-- è·³è¿‡æŒ‰é’® -->
                        <button @click="skipFarmingConfig" class="w-full bg-yellow-600 hover:bg-yellow-700 text-xs py-1.5 rounded mt-2 font-medium">â­ï¸ è·³è¿‡å½“å‰é…ç½®</button>
                    </div>
                </div>

                <!-- å…¨å±€æ“ä½œ -->
                <button @click="runTool('clear_all')" class="w-full bg-red-800 hover:bg-red-700 text-white py-2 rounded text-sm font-medium mb-4 flex items-center justify-center">
                    <span v-if="toolStatus.running && toolStatus.name === 'Clear All'" class="animate-spin mr-2">â³</span>
                    ğŸ§¹ æ¸…ç†æ‰€æœ‰è¿›ç¨‹
                </button>

                <div class="border-t border-gray-700 my-2"></div>
                <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">å·¥å…·ç®±</div>

                <!-- è®¢é˜…åœ°å›¾ -->
                <button @click="runTool('subscribe_map')" :disabled="toolStatus.running" class="w-full bg-gray-600 hover:bg-gray-500 disabled:opacity-50 text-xs py-2 rounded mb-2 flex items-center justify-center">
                    <span v-if="toolStatus.running && toolStatus.name === 'Subscribe Maps'" class="animate-spin mr-2">â³</span>
                    ğŸ—ºï¸ æ‰¹é‡è®¢é˜…åœ°å›¾
                </button>

                <!-- æŸ¥è¯¢æˆ¿é—´ -->
                <div class="space-y-2">
                    <label class="text-xs text-gray-400">æŸ¥è¯¢æˆ¿é—´ (æµ‹è¯•é¡¹ç›®:{{ queryGameId || 'å…¨éƒ¨' }})</label>
                    <input v-model="searchGameId" placeholder="ç•™ç©ºæŸ¥æ‰€æœ‰" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs">
                    <button @click="runTool('list_lobbies', { gameId: searchGameId })" :disabled="toolStatus.running" class="w-full bg-gray-600 hover:bg-gray-500 disabled:opacity-50 text-xs py-1 rounded flex items-center justify-center">
                        <span v-if="toolStatus.running && toolStatus.name === 'List Lobbies'" class="animate-spin mr-2">â³</span>
                        ğŸ” æŸ¥è¯¢
                    </button>
                </div>

            </nav>
            
            <div class="p-4 border-t border-gray-700 text-xs text-gray-500 text-center">
                Dota 2 Arcade Bot v6.0
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- é¡¶éƒ¨ Tab -->
            <div class="bg-gray-800 border-b border-gray-700 px-4 flex items-center">
                <!-- æ—¥å¿—é¡µç­¾ä¸‹æ‹‰èœå• -->
                <div class="relative group">
                    <button :class="currentTab.startsWith('log') ? 'border-blue-500 text-white' : 'border-transparent text-gray-400 hover:text-gray-200'" class="px-4 py-3 border-b-2 font-medium text-sm transition flex items-center">
                        è¿è¡Œæ—¥å¿— <span class="ml-1 text-xs">â–¼</span>
                    </button>
                    <div class="absolute left-0 top-full bg-gray-700 rounded shadow-lg z-20 hidden group-hover:block min-w-max">
                        <button @click="currentTab = 'log_all'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_all' ? 'text-blue-400' : 'text-gray-200'">ğŸ“‹ å…¨éƒ¨æ—¥å¿—</button>
                        <button @click="currentTab = 'log_showcase'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_showcase' ? 'text-blue-400' : 'text-gray-200'">ğŸ­ å±•ç¤ºè½¦é˜Ÿ</button>
                        <button @click="currentTab = 'log_farming'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_farming' ? 'text-blue-400' : 'text-gray-200'">ğŸŒ¾ æŒ‚æœºè½¦é˜Ÿ</button>
                        <button @click="currentTab = 'log_cleanup'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_cleanup' ? 'text-blue-400' : 'text-gray-200'">ğŸ§¹ æ¸…ç†æ—¥å¿—</button>
                        <button @click="currentTab = 'log_subscribe'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_subscribe' ? 'text-blue-400' : 'text-gray-200'">ğŸ—ºï¸ è®¢é˜…æ—¥å¿—</button>
                        <button @click="currentTab = 'log_query'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_query' ? 'text-blue-400' : 'text-gray-200'">ğŸ” æŸ¥è¯¢æ—¥å¿—</button>
                    </div>
                </div>
                <button @click="loadConfig('showcase')" :class="currentTab === 'config_showcase' ? 'border-blue-500 text-white' : 'border-transparent text-gray-400 hover:text-gray-200'" class="px-4 py-3 border-b-2 font-medium text-sm transition">å±•ç¤ºé…ç½®</button>
                <button @click="loadConfig('leaders')" :class="currentTab === 'config_leaders' ? 'border-blue-500 text-white' : 'border-transparent text-gray-400 hover:text-gray-200'" class="px-4 py-3 border-b-2 font-medium text-sm transition">ä¸»å·é…ç½®</button>
                <button @click="showFarmConfigs()" :class="currentTab === 'farm_configs' ? 'border-blue-500 text-white' : 'border-transparent text-gray-400 hover:text-gray-200'" class="px-4 py-3 border-b-2 font-medium text-sm transition">Farmé…ç½®</button>
            </div>

            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="flex-1 bg-gray-900 overflow-hidden relative">
                
                <!-- æ—¥å¿— Tab -->
                <div v-show="currentTab.startsWith('log')" class="h-full flex flex-col p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-sm font-semibold text-gray-400">{{ logTabTitle }}</h2>
                        <button @click="clearCurrentLogs" class="text-xs text-gray-500 hover:text-white">æ¸…ç©ºæ—¥å¿—</button>
                    </div>
                    
                    <!-- Stats å›ºå®šæ˜¾ç¤ºåŒºï¼ˆä»…æŒ‚æœºæ—¥å¿—ï¼‰ - æ€»ä½“ç»Ÿè®¡ -->
                    <div v-if="currentTab === 'log_farming' && farmingProgress" class="bg-gray-800 border border-blue-500/50 rounded p-3 mb-2 text-sm">
                        <div class="flex items-center flex-wrap gap-x-4 gap-y-1">
                            <span class="text-blue-400 font-bold">ğŸ“Š æ€»ä½“ç»Ÿè®¡</span>
                            <span class="text-gray-300">é…ç½®: <span class="text-white">{{ farmingProgress.currentConfigIndex + 1 }}/{{ farmingProgress.totalConfigs }}</span></span>
                            <span class="text-gray-300">æ€»è¿›åº¦: <span class="text-green-400 font-bold">{{ farmingTotalInLobby + farmingProgress.configProgress }}/{{ farmingTotalFollowers }} ({{ Math.round((farmingTotalInLobby + farmingProgress.configProgress) / farmingTotalFollowers * 100) || 0 }}%)</span></span>
                            <span class="text-gray-300">æ€»æˆ¿é—´: <span class="text-white">{{ farmingProgress.roomsCreated }}</span></span>
                            <span class="text-gray-300">æ€»æ—¶é•¿: <span class="text-yellow-400 font-bold">{{ formatElapsed(farmingTotalElapsed) }}</span></span>
                        </div>
                    </div>
                    
                    <div ref="logContainer" class="log-window rounded border border-gray-700 flex-1 p-2">
                        <div v-for="(log, idx) in filteredLogs" :key="idx" class="log-entry" :class="`log-${log.type}`">
                            <span class="opacity-50">[{{ log.timestamp }}]</span>
                            <span class="font-bold mx-1">[{{ log.source }}]</span>
                            <span v-html="formatMessage(log.message)"></span>
                        </div>
                    </div>
                </div>

                <!-- JSON é…ç½® Tab (showcase/leaders) -->
                <div v-show="currentTab === 'config_showcase' || currentTab === 'config_leaders'" class="h-full flex flex-col p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-sm font-semibold text-gray-400">
                            {{ currentTab === 'config_showcase' ? 'config_showcase.json' : 'config_leaders.json' }}
                        </h2>
                        <div class="space-x-2">
                            <span v-if="saveMessage" class="text-xs text-green-500">{{ saveMessage }}</span>
                            <button @click="saveConfig()" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded">ä¿å­˜ä¿®æ”¹</button>
                        </div>
                    </div>
                    <textarea v-model="configContent" class="flex-1 bg-gray-800 border border-gray-700 rounded p-4 font-mono text-sm resize-none focus:outline-none focus:border-blue-500"></textarea>
                </div>
                
                <!-- Farm é…ç½®ç¼–è¾‘ Tab (æ–‡æœ¬æ ¼å¼) -->
                <div v-show="currentTab === 'config_farm'" class="h-full flex flex-col p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-sm font-semibold text-gray-400">
                            ğŸ“¦ {{ editingFarmConfig }} <span class="text-gray-500 text-xs">ï¼ˆæ ¼å¼ï¼šç”¨æˆ·å,å¯†ç ï¼‰</span>
                        </h2>
                        <div class="space-x-2">
                            <button @click="showFarmConfigs()" class="bg-gray-600 hover:bg-gray-500 text-white text-xs px-3 py-1 rounded">â† è¿”å›åˆ—è¡¨</button>
                            <span v-if="saveMessage" class="text-xs text-green-500">{{ saveMessage }}</span>
                            <button @click="saveFarmConfig()" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded">ä¿å­˜ä¿®æ”¹</button>
                        </div>
                    </div>
                    <div class="flex-1 flex gap-4 min-h-0">
                        <!-- å°å·åˆ—è¡¨ -->
                        <div class="flex-1 flex flex-col">
                            <label class="text-xs text-gray-400 mb-1">ğŸ® å°å·åˆ—è¡¨ (followers.txt)</label>
                            <textarea v-model="farmFollowersContent" placeholder="ç”¨æˆ·å,å¯†ç &#10;ç”¨æˆ·å,å¯†ç &#10;..." class="flex-1 bg-gray-800 border border-gray-700 rounded p-3 font-mono text-xs resize-none focus:outline-none focus:border-blue-500"></textarea>
                        </div>
                        <!-- ä»£ç†åˆ—è¡¨ -->
                        <div class="w-1/3 flex flex-col">
                            <label class="text-xs text-gray-400 mb-1">ğŸŒ ä»£ç†åˆ—è¡¨ (proxies.txt)</label>
                            <textarea v-model="farmProxiesContent" placeholder="http://user:pass@host:port&#10;..." class="flex-1 bg-gray-800 border border-gray-700 rounded p-3 font-mono text-xs resize-none focus:outline-none focus:border-blue-500"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Farm é…ç½®åˆ—è¡¨ Tab -->
                <div v-show="currentTab === 'farm_configs'" class="h-full flex flex-col p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-white">ğŸ“ Farm é…ç½®åˆ—è¡¨</h2>
                        <div class="flex space-x-2">
                            <button @click="refreshFarmConfigs" class="bg-gray-600 hover:bg-gray-500 text-white text-xs px-3 py-1 rounded">ğŸ”„ åˆ·æ–°</button>
                            <button @click="addFarmConfig" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded">â• æ·»åŠ é…ç½®</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-800 sticky top-0">
                                <tr>
                                    <th class="text-left px-4 py-2 text-gray-400">é…ç½®å</th>
                                    <th class="text-right px-4 py-2 text-gray-400">å°å·æ•°</th>
                                    <th class="text-right px-4 py-2 text-gray-400">ä»£ç†æ•°</th>
                                    <th class="text-center px-4 py-2 text-gray-400">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="cfg in farmConfigs" :key="cfg.name" class="border-b border-gray-700 hover:bg-gray-800/50">
                                    <td class="px-4 py-3">
                                        <span class="font-mono">{{ cfg.name }}</span>
                                        <span v-if="farmingProgress && farmingProgress.currentConfig === cfg.name" class="ml-2 text-xs bg-green-600 px-1 rounded">è¿è¡Œä¸­</span>
                                    </td>
                                    <td class="px-4 py-3 text-right text-gray-300">{{ cfg.followers }}</td>
                                    <td class="px-4 py-3 text-right text-gray-300">{{ cfg.proxies }}</td>
                                    <td class="px-4 py-3 text-center">
                                        <button @click="editFarmConfig(cfg.name)" class="text-blue-400 hover:text-blue-300 text-xs">ç¼–è¾‘</button>
                                    </td>
                                </tr>
                                <tr v-if="farmConfigs.length === 0">
                                    <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                                        æš‚æ— é…ç½®ï¼Œç‚¹å‡»ã€Œæ·»åŠ é…ç½®ã€åˆ›å»º
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <!-- Steam Guard éªŒè¯ç å¼¹çª— -->
        <div v-if="steamGuardVisible" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50" @click.self="cancelSteamGuard">
            <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl border border-gray-700">
                <h3 class="text-lg font-semibold text-white mb-4">ğŸ” Steam Guard éªŒè¯</h3>
                <p class="text-sm text-gray-400 mb-4">éœ€è¦éªŒè¯ç  ({{ steamGuardDomain }})</p>
                <input 
                    v-model="steamGuardCode" 
                    @keyup.enter="submitSteamGuard"
                    type="text" 
                    placeholder="è¯·è¾“å…¥éªŒè¯ç "
                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white mb-4 focus:outline-none focus:border-blue-500"
                    autofocus
                >
                <div class="flex space-x-2">
                    <button @click="submitSteamGuard" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-medium transition">æäº¤</button>
                    <button @click="cancelSteamGuard" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded font-medium transition">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
        const socket = io();

        createApp({
            setup() {
                const status = ref({ showcase: false, farming: false });
                const toolStatus = ref({ running: false, name: null });
                const logs = ref([]);
                const currentTab = ref('log_all');
                const logContainer = ref(null);
                const farmingStats = ref(null); // æŒ‚æœºè½¦é˜Ÿå®æ—¶çŠ¶æ€ï¼ˆæ€»ä½“ï¼‰
                const farmingProgress = ref(null); // æŒ‚æœºè½¦é˜Ÿè¿›åº¦ä¿¡æ¯
                let farmingElapsedTimer = null;   // æ—¶é—´æ›´æ–°å®šæ—¶å™¨
                let farmingTotalStartTime = null; // æ€»è¿è¡Œå¼€å§‹æ—¶é—´
                const farmingTotalElapsed = ref(0); // æ€»è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
                const farmingTotalInLobby = ref(0); // æ€»è¿›å…¥æˆ¿é—´äººæ•°
                const farmingTotalFollowers = ref(0); // æ€»å°å·æ•°é‡ï¼ˆç´¯è®¡ï¼‰
                const processedConfigs = new Set(); // å·²å¤„ç†çš„é…ç½®ï¼ˆé˜²æ­¢é‡å¤ç´¯åŠ ï¼‰
                let configStartRooms = 0; // å½“å‰é…ç½®å¼€å§‹æ—¶çš„æ€»æˆ¿é—´æ•°
                
                // é…ç½®ç¼–è¾‘
                const configContent = ref('');
                const currentConfigType = ref(null);
                const saveMessage = ref('');

                // Farm é…ç½®åˆ—è¡¨
                const farmConfigs = ref([]);
                const editingFarmConfig = ref(null);

                // å·¥å…·å‚æ•°
                const searchGameId = ref('');
                const queryGameId = ref('');

                // é¢†é˜Ÿåˆ—è¡¨
                const showcaseLeaders = ref([]);
                const selectedShowcaseLeader = ref('');

                // Steam Guard éªŒè¯ç 
                const steamGuardVisible = ref(false);
                const steamGuardDomain = ref('');
                const steamGuardCode = ref('');
                const steamGuardKey = ref('');

                // è‡ªåŠ¨æ»šåŠ¨æ—¥å¿—
                const scrollToBottom = () => {
                    nextTick(() => {
                        if (logContainer.value) {
                            logContainer.value.scrollTop = logContainer.value.scrollHeight;
                        }
                    });
                };

                // æ—¥å¿—é¡µç­¾æ ‡é¢˜
                const logTabTitle = computed(() => {
                    const titles = {
                        'log_all': 'ğŸ“‹ å…¨éƒ¨æ—¥å¿—',
                        'log_showcase': 'ğŸ­ å±•ç¤ºè½¦é˜Ÿæ—¥å¿—',
                        'log_farming': 'ğŸŒ¾ æŒ‚æœºè½¦é˜Ÿæ—¥å¿—',
                        'log_cleanup': 'ğŸ§¹ æ¸…ç†æ—¥å¿—',
                        'log_subscribe': 'ğŸ—ºï¸ è®¢é˜…æ—¥å¿—',
                        'log_query': 'ğŸ” æŸ¥è¯¢æ—¥å¿—'
                    };
                    return titles[currentTab.value] || 'ç³»ç»Ÿæ—¥å¿—';
                });

                // è¿‡æ»¤æ—¥å¿—
                const filteredLogs = computed(() => {
                    const tab = currentTab.value;
                    if (tab === 'log_all') return logs.value;
                    
                    return logs.value.filter(log => {
                        const src = log.source.toLowerCase();
                        const msg = log.message.toLowerCase();
                        switch (tab) {
                            case 'log_showcase':
                                // å±•ç¤ºè½¦é˜Ÿï¼šåŒ…æ‹¬ showcase å’Œ showcase-cleanup
                                return src === 'showcase' || src === 'showcase-cleanup' ||
                                       (src === 'system' && msg.includes('showcase'));
                            case 'log_farming':
                                // æŒ‚æœºè½¦é˜Ÿï¼šåŒ…æ‹¬ farming å’Œ farming-cleanup
                                return src === 'farming' || src === 'farming-cleanup' ||
                                       (src === 'system' && msg.includes('farming'));
                            case 'log_cleanup':
                                // æ¸…ç†æ—¥å¿—ï¼šåªæ˜¾ç¤ºã€Œæ¸…ç†æ‰€æœ‰è¿›ç¨‹ã€çš„æ—¥å¿—
                                return src === 'clear_all' || src === 'clear-all' ||
                                       (src === 'system' && msg.includes('æ¸…ç†æ‰€æœ‰'));
                            case 'log_subscribe':
                                return src === 'subscribe' || src === 'subscribe_map' ||
                                       (src === 'system' && msg.includes('è®¢é˜…'));
                            case 'log_query':
                                return src === 'tool' || src === 'list_lobbies' ||
                                       (src === 'system' && msg.includes('æŸ¥è¯¢'));
                            default:
                                return true;
                        }
                    });
                });

                // æ¸…ç©ºå½“å‰é¡µç­¾æ—¥å¿—
                const clearCurrentLogs = () => {
                    if (currentTab.value === 'log_all') {
                        logs.value = [];
                    } else {
                        // åªä¿ç•™ä¸å±äºå½“å‰é¡µç­¾çš„æ—¥å¿—
                        logs.value = logs.value.filter(log => !filteredLogs.value.includes(log));
                    }
                };

                // æ ¼å¼åŒ–æ—¥å¿—æ¶ˆæ¯
                const formatMessage = (msg) => {
                    // è¯†åˆ«æ–‡ä»¶é“¾æ¥æ ‡è®°
                    if (msg.includes('[FILE_LINK]')) {
                        const filepath = msg.replace('[FILE_LINK]', '').trim();
                        const filename = filepath.split('\\').pop();
                        return `ç»“æœå·²ä¿å­˜åˆ°: <a href="/api/csv/${filename}" target="_blank" class="text-blue-400 hover:text-blue-300 underline">${filename}</a> ğŸ“¥`;
                    }
                    return msg.replace(/\n/g, '<br>');
                };

                // Socket ç›‘å¬
                onMounted(() => {
                    socket.on('log', (log) => {
                        logs.value.push(log);
                        if (logs.value.length > 1000) logs.value.shift();
                        scrollToBottom();
                        
                        // æå–æŒ‚æœºè½¦é˜Ÿ Stats ä¿¡æ¯
                        // æ—¥å¿—æ ¼å¼: [æ—¶é—´][Stats] [config_000] è¿›åº¦: 50/999 (5%) | æˆ¿é—´: 3 | é…ç½®: 1/1 | è¿è¡Œ: 5åˆ†30ç§’
                        if (log.source === 'farming' && log.message.includes('è¿›åº¦:') && log.message.includes('é…ç½®:')) {
                            // æ›´å®½æ¾çš„æ­£åˆ™ï¼Œæ”¯æŒ config_XXX æˆ– - ä½œä¸ºé…ç½®å
                            const match = log.message.match(/\[(config_\d+|-)\]\s*è¿›åº¦:\s*(\d+)\/(\d+)\s*\((\d+)%\)/);
                            const roomMatch = log.message.match(/æˆ¿é—´:\s*(\d+)/);
                            const cfgMatch = log.message.match(/é…ç½®:\s*(\d+)\/(\d+)/);
                            
                            if (match && cfgMatch) {
                                const newConfigName = match[1];
                                const configChanged = farmingProgress.value?.currentConfig !== newConfigName;
                                const currentInLobby = parseInt(match[2]);
                                const currentTotal = parseInt(match[3]);
                                const totalRooms = roomMatch ? parseInt(roomMatch[1]) : 0;
                                
                                // é…ç½®åˆ‡æ¢æ—¶ï¼šç´¯åŠ ä¸Šä¸€ä¸ªé…ç½®çš„è¿›å…¥äººæ•°ï¼Œè®°å½•æˆ¿é—´åŸºå‡†
                                if (configChanged && farmingProgress.value) {
                                    farmingTotalInLobby.value += farmingProgress.value.configProgress || 0;
                                    configStartRooms = totalRooms; // æ–°é…ç½®å¼€å§‹æ—¶çš„æˆ¿é—´æ•°
                                }
                                
                                // è®¡ç®—å½“å‰é…ç½®çš„æˆ¿é—´æ•°
                                const configRooms = totalRooms - configStartRooms;
                                
                                farmingProgress.value = {
                                    currentConfig: newConfigName,
                                    configProgress: currentInLobby,
                                    configTotal: currentTotal,
                                    percent: parseInt(match[4]),
                                    roomsCreated: totalRooms,      // æ€»æˆ¿é—´æ•°ï¼ˆé¡¶éƒ¨ç»Ÿè®¡ç”¨ï¼‰
                                    configRooms: configRooms,      // å½“å‰é…ç½®æˆ¿é—´æ•°ï¼ˆä¾§è¾¹æ ç”¨ï¼‰
                                    currentConfigIndex: parseInt(cfgMatch[1]) - 1,
                                    totalConfigs: parseInt(cfgMatch[2]),
                                    // é…ç½®å˜åŒ–æ—¶é‡ç½®å¼€å§‹æ—¶é—´ï¼Œå¦åˆ™ä¿ç•™
                                    configStartTime: configChanged ? Date.now() : (farmingProgress.value?.configStartTime || Date.now()),
                                    configElapsed: configChanged ? 0 : (farmingProgress.value?.configElapsed || 0)
                                };
                            }
                        }
                        
                        // è½¦é˜Ÿåœæ­¢/æ¸…ç†å®Œæˆæ—¶ï¼Œæ¸…ç©º Stats
                        if (log.message.includes('è½¦é˜Ÿæ¸…ç†å®Œæˆ') || 
                            log.message.includes('è¿›ç¨‹å·²å®Œå…¨åœæ­¢') ||
                            log.message.includes('farming è¿›ç¨‹å·²é€€å‡º')) {
                            farmingStats.value = null;
                            farmingProgress.value = null;
                        }
                    });

                    socket.on('status', (newStatus) => {
                        status.value = { ...status.value, ...newStatus };
                        
                        // æŒ‚æœºè½¦é˜Ÿå¯åŠ¨æ—¶ï¼Œå¯åŠ¨æ—¶é—´æ›´æ–°å®šæ—¶å™¨
                        if (newStatus.farming === true && !farmingElapsedTimer) {
                            farmingTotalStartTime = Date.now();
                            farmingTotalElapsed.value = 0;
                            farmingTotalInLobby.value = 0;
                            farmingTotalFollowers.value = 0;
                            processedConfigs.clear();
                            configStartRooms = 0;
                            
                            // å¯åŠ¨æ—¶è·å–æ‰€æœ‰é…ç½®çš„æ€»å°å·æ•°
                            fetch('/api/farm/configs').then(r => r.json()).then(data => {
                                if (data.configs && data.configs.length > 0) {
                                    farmingTotalFollowers.value = data.configs.reduce((sum, cfg) => sum + (cfg.followers || 0), 0);
                                }
                            }).catch(() => {});
                            
                            farmingElapsedTimer = setInterval(() => {
                                // æ›´æ–°å½“å‰é…ç½®æ—¶é—´
                                if (farmingProgress.value && farmingProgress.value.configStartTime) {
                                    farmingProgress.value.configElapsed = Math.floor((Date.now() - farmingProgress.value.configStartTime) / 1000);
                                }
                                // æ›´æ–°æ€»è¿è¡Œæ—¶é—´
                                if (farmingTotalStartTime) {
                                    farmingTotalElapsed.value = Math.floor((Date.now() - farmingTotalStartTime) / 1000);
                                }
                            }, 1000);
                        }
                        
                        // æŒ‚æœºè½¦é˜Ÿåœæ­¢æ—¶ï¼Œæ¸…ç©º Stats å’Œå®šæ—¶å™¨
                        if (newStatus.farming === false) {
                            farmingStats.value = null;
                            farmingProgress.value = null;
                            farmingTotalStartTime = null;
                            if (farmingElapsedTimer) {
                                clearInterval(farmingElapsedTimer);
                                farmingElapsedTimer = null;
                            }
                        }
                    });
                    
                    socket.on('toolStatus', (newToolStatus) => {
                        toolStatus.value = newToolStatus;
                    });

                    // è·å–åˆå§‹çŠ¶æ€
                    fetch('/api/status').then(r => r.json()).then(res => {
                        status.value = { showcase: res.showcase, farming: res.farming };
                        toolStatus.value = res.tool;
                    });

                    // ç›‘å¬ Steam Guard è¯·æ±‚
                    socket.on('needSteamGuard', ({ key, domain }) => {
                        steamGuardVisible.value = true;
                        steamGuardDomain.value = domain;
                        steamGuardKey.value = key;
                        steamGuardCode.value = '';
                    });

                    // åŠ è½½é¢†é˜Ÿåˆ—è¡¨
                    loadLeaders();
                });

                // API è°ƒç”¨
                const toggleProcess = async (name, action) => {
                    // åˆ‡æ¢åˆ°å¯¹åº”è½¦é˜Ÿçš„æ—¥å¿—é¡µç­¾ï¼ˆå¯åŠ¨å’Œåœæ­¢éƒ½åœ¨åŒä¸€ä¸ªé¡µç­¾ï¼‰
                    currentTab.value = name === 'showcase' ? 'log_showcase' : 'log_farming';
                    try {
                        await fetch(`/api/process/${name}/${action}`, { method: 'POST' });
                    } catch (e) {
                        logs.value.push({ timestamp: '', source: 'System', message: `API Error: ${e.message}`, type: 'error' });
                    }
                };

                const runTool = async (name, body = {}) => {
                    // æ ¹æ®å·¥å…·ç±»å‹åˆ‡æ¢åˆ°å¯¹åº”æ—¥å¿—é¡µç­¾
                    if (name === 'clear_all') {
                        currentTab.value = 'log_cleanup';
                    } else if (name === 'subscribe_map') {
                        currentTab.value = 'log_subscribe';
                    } else if (name === 'list_lobbies') {
                        currentTab.value = 'log_query';
                    } else {
                        currentTab.value = 'log_all';
                    }
                    try {
                        const res = await fetch(`/api/tool/${name}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });
                        if (!res.ok) {
                            const err = await res.json();
                            alert('æ“ä½œå¤±è´¥: ' + err.error);
                        }
                    } catch (e) {
                        alert('è¯·æ±‚å¤±è´¥');
                    }
                };

                const loadLeaders = async () => {
                    try {
                        // åŠ è½½å±•ç¤ºè½¦é˜Ÿé¢†é˜Ÿ
                        const showcaseRes = await fetch('/api/config/showcase');
                        const showcaseData = await showcaseRes.json();
                        showcaseLeaders.value = showcaseData.showcase_leaders || [];
                        
                        // åŠ è½½æµ‹è¯•é¡¹ç›® ID
                        if (showcaseData.global_settings && showcaseData.global_settings.custom_game_id) {
                            queryGameId.value = showcaseData.global_settings.custom_game_id;
                        }
                    } catch (e) {
                        console.error('åŠ è½½é¢†é˜Ÿåˆ—è¡¨å¤±è´¥', e);
                    }
                };

                const verifyLeader = async (type, username) => {
                    if (!username) return;
                    currentTab.value = 'log_showcase';
                    try {
                        const res = await fetch(`/api/tool/login_leader`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ type, username })
                        });
                        if (!res.ok) {
                            const err = await res.json();
                            alert('æ“ä½œå¤±è´¥: ' + err.error);
                        }
                    } catch (e) {
                        alert('è¯·æ±‚å¤±è´¥');
                    }
                };

                // Farm é…ç½®ç›¸å…³æ–¹æ³•
                const refreshFarmConfigs = async () => {
                    try {
                        const res = await fetch('/api/farm/configs');
                        const data = await res.json();
                        farmConfigs.value = data.configs || [];
                    } catch (e) {
                        console.error('åŠ è½½ Farm é…ç½®å¤±è´¥', e);
                    }
                };

                const showFarmConfigs = () => {
                    currentTab.value = 'farm_configs';
                    refreshFarmConfigs();
                };

                const addFarmConfig = async () => {
                    // è‡ªåŠ¨ç”Ÿæˆä¸‹ä¸€ä¸ªé…ç½®å
                    const existingNums = farmConfigs.value.map(c => {
                        const match = c.name.match(/config_(\d+)/);
                        return match ? parseInt(match[1]) : -1;
                    });
                    const nextNum = existingNums.length > 0 ? Math.max(...existingNums) + 1 : 0;
                    const newName = `config_${String(nextNum).padStart(3, '0')}`;
                    
                    if (!confirm(`åˆ›å»ºæ–°é…ç½®: ${newName}ï¼Ÿ`)) return;
                    
                    try {
                        const res = await fetch('/api/farm/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: newName })
                        });
                        if (res.ok) {
                            refreshFarmConfigs();
                            editFarmConfig(newName);
                        } else {
                            const err = await res.json();
                            alert('åˆ›å»ºå¤±è´¥: ' + err.error);
                        }
                    } catch (e) {
                        alert('è¯·æ±‚å¤±è´¥');
                    }
                };

                // Farm é…ç½®ç¼–è¾‘ï¼ˆæ–°æ ¼å¼ï¼šæ–‡æœ¬ï¼‰
                const farmFollowersContent = ref('');
                const farmProxiesContent = ref('');
                
                const editFarmConfig = async (name) => {
                    currentTab.value = 'config_farm';
                    currentConfigType.value = `farm/${name}`;
                    editingFarmConfig.value = name;
                    saveMessage.value = '';
                    try {
                        const res = await fetch(`/api/farm/config/${name}`);
                        const data = await res.json();
                        farmFollowersContent.value = data.followers || '';
                        farmProxiesContent.value = data.proxies || '';
                    } catch (e) {
                        farmFollowersContent.value = '// åŠ è½½å¤±è´¥';
                        farmProxiesContent.value = '';
                    }
                };
                
                const saveFarmConfig = async () => {
                    if (!editingFarmConfig.value) return;
                    try {
                        const res = await fetch(`/api/farm/config/${editingFarmConfig.value}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                followers: farmFollowersContent.value,
                                proxies: farmProxiesContent.value
                            })
                        });
                        
                        if (res.ok) {
                            saveMessage.value = 'ä¿å­˜æˆåŠŸ!';
                            setTimeout(() => saveMessage.value = '', 3000);
                        } else {
                            alert('ä¿å­˜å¤±è´¥');
                        }
                    } catch (e) {
                        alert('è¯·æ±‚å¤±è´¥');
                    }
                };

                // è·³è¿‡å½“å‰é…ç½®
                const skipFarmingConfig = async () => {
                    if (!confirm('ç¡®å®šè·³è¿‡å½“å‰é…ç½®ï¼Ÿ')) return;
                    try {
                        const res = await fetch('/api/farm/skip', { method: 'POST' });
                        if (!res.ok) {
                            const err = await res.json();
                            alert('æ“ä½œå¤±è´¥: ' + err.error);
                        }
                    } catch (e) {
                        alert('è¯·æ±‚å¤±è´¥');
                    }
                };

                // æ ¼å¼åŒ–è¿è¡Œæ—¶é—´
                const formatElapsed = (seconds) => {
                    if (!seconds) return '0ç§’';
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    const s = seconds % 60;
                    if (h > 0) return `${h}æ—¶${m}åˆ†`;
                    if (m > 0) return `${m}åˆ†${s}ç§’`;
                    return `${s}ç§’`;
                };

                const submitSteamGuard = () => {
                    if (!steamGuardCode.value.trim()) {
                        alert('è¯·è¾“å…¥éªŒè¯ç ');
                        return;
                    }
                    socket.emit('submitSteamGuard', { 
                        key: steamGuardKey.value, 
                        code: steamGuardCode.value.trim() 
                    });
                    steamGuardVisible.value = false;
                };

                const cancelSteamGuard = () => {
                    steamGuardVisible.value = false;
                };

                const loadConfig = async (type) => {
                    currentTab.value = `config_${type}`;
                    currentConfigType.value = type;
                    editingFarmConfig.value = null;
                    saveMessage.value = '';
                    try {
                        const res = await fetch(`/api/config/${type}`);
                        const data = await res.json();
                        configContent.value = JSON.stringify(data, null, 2);
                    } catch (e) {
                        configContent.value = '// åŠ è½½å¤±è´¥';
                    }
                };

                const saveConfig = async () => {
                    try {
                        const json = JSON.parse(configContent.value);
                        
                        // åˆ¤æ–­æ˜¯å¦æ˜¯ farm é…ç½®
                        let url;
                        if (currentConfigType.value && currentConfigType.value.startsWith('farm/')) {
                            const name = currentConfigType.value.replace('farm/', '');
                            url = `/api/farm/config/${name}`;
                        } else {
                            url = `/api/config/${currentConfigType.value}`;
                        }
                        
                        const res = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(json)
                        });
                        
                        if (res.ok) {
                            saveMessage.value = 'ä¿å­˜æˆåŠŸ!';
                            setTimeout(() => saveMessage.value = '', 3000);
                        } else {
                            alert('ä¿å­˜å¤±è´¥');
                        }
                    } catch (e) {
                        alert('JSON æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥');
                    }
                };

                return {
                    status, toolStatus, logs, currentTab, logContainer,
                    toggleProcess, runTool, formatMessage,
                    configContent, loadConfig, saveConfig, saveMessage,
                    searchGameId, queryGameId,
                    showcaseLeaders, selectedShowcaseLeader,
                    loadLeaders, verifyLeader,
                    steamGuardVisible, steamGuardDomain, steamGuardCode, 
                    submitSteamGuard, cancelSteamGuard,
                    // æ—¥å¿—é¡µç­¾ç›¸å…³
                    logTabTitle, filteredLogs, clearCurrentLogs, farmingStats,
                    farmingTotalElapsed, farmingTotalInLobby, farmingTotalFollowers,
                    // Farm é…ç½®ç›¸å…³
                    farmConfigs, farmingProgress, editingFarmConfig,
                    farmFollowersContent, farmProxiesContent,
                    refreshFarmConfigs, showFarmConfigs, addFarmConfig, editFarmConfig,
                    saveFarmConfig, skipFarmingConfig, formatElapsed
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
