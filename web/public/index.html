<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dota 2 Bot æ§åˆ¶å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .log-window {
            height: 500px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
        }
        .log-entry { margin: 2px 0; border-bottom: 1px solid #333; padding: 2px 5px; }
        .log-info { color: #d4d4d4; }
        .log-success { color: #4ade80; }
        .log-warning { color: #facc15; }
        .log-error { color: #f87171; }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }
        
        /* è¿›åº¦æ¡åŠ¨ç”» */
        .progress-bar {
            background: linear-gradient(
                90deg,
                rgba(34, 197, 94, 1) 0%,
                rgba(74, 222, 128, 1) 50%,
                rgba(34, 197, 94, 1) 100%
            );
            background-size: 200% 100%;
            animation: shimmer 2s ease-in-out infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* è¿›åº¦æ¡æ¡çº¹æ•ˆæœ */
        .progress-stripes {
            background-image: linear-gradient(
                45deg,
                rgba(255,255,255,0.15) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255,255,255,0.15) 50%,
                rgba(255,255,255,0.15) 75%,
                transparent 75%,
                transparent
            );
            background-size: 1rem 1rem;
            animation: progress-stripes 1s linear infinite;
        }
        @keyframes progress-stripes {
            from { background-position: 1rem 0; }
            to { background-position: 0 0; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex flex-col overflow-hidden">
    <div id="app" class="flex h-full">
        
        <!-- ä¾§è¾¹æ  -->
        <div class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col">
            <div class="p-4 font-bold text-xl border-b border-gray-700 flex items-center">
                <span class="text-blue-500 mr-2">ğŸ¤–</span> Dota 2 Bot
            </div>
            
            <nav class="flex-1 overflow-y-auto p-2 space-y-2">
                <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">æ§åˆ¶é¢æ¿</div>
                
                <!-- å±•ç¤ºè½¦é˜Ÿ -->
                <div class="bg-gray-700/50 rounded p-3 mb-2">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium">å±•ç¤ºè½¦é˜Ÿ</span>
                        <span :class="status.showcase ? 'bg-green-500' : 'bg-red-500'" class="w-2 h-2 rounded-full"></span>
                    </div>
                    <div class="flex space-x-2 mb-2">
                        <button @click="toggleProcess('showcase', 'start')" :disabled="status.showcase" class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-xs py-1 px-2 rounded transition">å¯åŠ¨</button>
                        <button @click="toggleProcess('showcase', 'stop')" :disabled="!status.showcase" class="flex-1 bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed text-xs py-1 px-2 rounded transition">åœæ­¢</button>
                    </div>
                    <div class="border-t border-gray-600 pt-2 mt-2">
                        <label class="text-xs text-gray-400 block mb-1">å¤§å·éªŒè¯</label>
                        <select v-model="selectedShowcaseLeader" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs mb-1">
                            <option value="">-- é€‰æ‹©è´¦å· --</option>
                            <option v-for="(leader, idx) in showcaseLeaders" :key="idx" :value="leader.username">{{ leader.username }}</option>
                        </select>
                        <button @click="verifyLeader('showcase', selectedShowcaseLeader)" :disabled="!selectedShowcaseLeader || toolStatus.running" class="w-full bg-gray-600 hover:bg-gray-500 disabled:opacity-50 text-xs py-1 rounded">éªŒè¯</button>
                    </div>
                </div>

                <!-- æŒ‚æœºè½¦é˜Ÿ -->
                <div class="bg-gray-700/50 rounded p-3 mb-2">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium">æŒ‚æœºè½¦é˜Ÿ</span>
                        <span :class="status.farming ? 'bg-green-500' : 'bg-red-500'" class="w-2 h-2 rounded-full"></span>
                    </div>
                    <div class="flex space-x-2">
                        <button @click="toggleProcess('farming', 'start')" :disabled="status.farming" class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-xs py-1 px-2 rounded transition">å¯åŠ¨</button>
                        <button @click="toggleProcess('farming', 'stop')" :disabled="!status.farming" class="flex-1 bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed text-xs py-1 px-2 rounded transition">åœæ­¢</button>
                    </div>
                    <!-- ğŸ”´ ä¸»å·å¯åœï¼ˆå¯åœæ­¢/å¯åŠ å›ï¼‰ -->
                    <div class="border-t border-gray-600 pt-2 mt-2">
                        <label class="text-xs text-gray-400 block mb-1">ğŸ‘‘ ä¸»å·æ§åˆ¶</label>
                        <select v-model="selectedFarmingLeader" :disabled="!status.farming" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs mb-1">
                            <option value="">-- é€‰æ‹©ä¸»å· --</option>
                            <option v-for="(leader, idx) in farmingLeaders" :key="idx" :value="leader.username">{{ formatFarmingLeaderOption(leader.username) }}</option>
                        </select>
                        <div v-if="selectedFarmingLeader" class="text-[11px] text-gray-400 mb-1">
                            çŠ¶æ€ï¼š<span :class="isSelectedFarmingLeaderStopped ? 'text-red-300' : 'text-green-300'">{{ isSelectedFarmingLeaderStopped ? 'å·²åœæ­¢' : 'è¿è¡Œä¸­' }}</span>
                        </div>
                        <button v-if="!isSelectedFarmingLeaderStopped"
                                @click="stopFarmingLeader(selectedFarmingLeader)"
                                :disabled="!status.farming || !selectedFarmingLeader"
                                class="w-full bg-red-700 hover:bg-red-600 disabled:opacity-50 text-xs py-1 rounded">
                            åœæ­¢è¯¥ä¸»å·
                        </button>
                        <button v-else
                                @click="startFarmingLeader(selectedFarmingLeader)"
                                :disabled="!status.farming || !selectedFarmingLeader"
                                class="w-full bg-green-700 hover:bg-green-600 disabled:opacity-50 text-xs py-1 rounded">
                            å¯åŠ¨è¯¥ä¸»å·
                        </button>
                    </div>
                </div>

                <div class="border-t border-gray-700 my-2"></div>
                <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">å·¥å…·ç®±</div>

                <!-- æ¸¸æˆIDè¾“å…¥ï¼ˆæ”¾æœ€ä¸Šé¢ï¼Œå¤šä¸ªå·¥å…·å…±ç”¨ï¼‰ -->
                <div class="mb-3">
                    <label class="text-xs text-gray-400 block mb-1">ğŸ® æ¸¸æˆID (æµ‹è¯•é¡¹ç›®:{{ queryGameId || 'æœªè®¾ç½®' }})</label>
                    <input v-model="toolGameId" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs">
                </div>

                <!-- æ‰¹é‡è®¢é˜…åœ°å›¾ -->
                <div class="mb-3">
                    <label class="text-xs text-gray-400 block mb-1">ğŸ—ºï¸ æ‰¹é‡è®¢é˜…åœ°å›¾</label>
                    <select v-model="subscribeConfigName" :disabled="toolStatus.running && toolStatus.name === 'Subscribe Maps'" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs mb-1">
                        <option value="">-- é€‰æ‹©é…ç½® --</option>
                        <option v-for="cfg in farmConfigs" :key="cfg.name" :value="cfg.name">{{ cfg.name }} ({{ cfg.followers }}äºº)</option>
                    </select>
                    <!-- ä¸¤ä¸ªæŒ‰é’®å¹¶æ’ï¼šè®¢é˜… + åœæ­¢ -->
                    <div class="flex space-x-2">
                        <button @click="subscribeMap()" :disabled="toolStatus.running || !subscribeConfigName" class="flex-1 bg-gray-600 hover:bg-gray-500 disabled:opacity-50 text-xs py-1.5 rounded flex items-center justify-center">
                            <span v-if="toolStatus.running && toolStatus.name === 'Subscribe Maps'" class="animate-spin mr-1">â³</span>
                            è®¢é˜…
                        </button>
                        <button type="button" 
                                onclick="fetch('/api/tool/stop',{method:'POST'}).then(r=>r.json()).then(d=>console.log('åœæ­¢ç»“æœ:',d)).catch(e=>console.error(e))"
                                :disabled="!(toolStatus.running && toolStatus.name === 'Subscribe Maps')"
                                class="flex-1 bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:bg-gray-600 text-xs py-1.5 rounded">
                            åœæ­¢
                        </button>
                    </div>
                </div>

                <!-- æŸ¥è¯¢æˆ¿é—´ -->
                <div class="mb-3">
                    <button @click="runTool('list_lobbies', { gameId: toolGameId })" :disabled="toolStatus.running" class="w-full bg-gray-600 hover:bg-gray-500 disabled:opacity-50 text-xs py-1.5 rounded flex items-center justify-center">
                        <span v-if="toolStatus.running && toolStatus.name === 'List Lobbies'" class="animate-spin mr-2">â³</span>
                        ğŸ” æŸ¥è¯¢æˆ¿é—´ (ç•™ç©ºæŸ¥è¯¢æ‰€æœ‰)
                    </button>
                </div>

                <!-- ä»£ç†æµ‹è¯• -->
                <div class="mb-3">
                    <button @click="runTool('test_proxies')" :disabled="toolStatus.running" class="w-full bg-orange-600 hover:bg-orange-500 disabled:opacity-50 text-xs py-1.5 rounded flex items-center justify-center">
                        <span v-if="toolStatus.running && toolStatus.name === 'Test Proxies'" class="animate-spin mr-2">â³</span>
                        ğŸ”Œ æµ‹è¯•ä»£ç†å¯ç”¨æ€§
                    </button>
                </div>

                <div class="border-t border-gray-700 my-2"></div>
                <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">ä¸»å·æµ‹è¯•</div>

                <!-- æµ‹è¯•æŒ‚æœºä¸»å· -->
                <div class="bg-gray-700/50 rounded p-3 mb-2">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-medium">ğŸ‘‘ æµ‹è¯•æŒ‚æœºä¸»å·</span>
                    </div>
                    <input v-model="testLeader.username" placeholder="è´¦å·" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs mb-1">
                    <input v-model="testLeader.password" type="password" placeholder="å¯†ç " class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs mb-1">
                    <input v-model="testLeader.proxy" placeholder="ä»£ç† (å¯é€‰)" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs mb-1">
                    <input v-model="testLeader.shared_secret" placeholder="shared_secret (å¯é€‰)" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs mb-2">
                    <div class="flex space-x-2">
                        <button @click="startTestLeader" :disabled="toolStatus.running || !testLeader.username || !testLeader.password" class="flex-1 bg-green-600 hover:bg-green-700 disabled:opacity-50 text-xs py-1.5 rounded flex items-center justify-center">
                            <span v-if="toolStatus.running && toolStatus.name?.startsWith('Test Leader')" class="animate-spin mr-1">â³</span>
                            ğŸ  åˆ›å»ºæˆ¿é—´
                        </button>
                        <button @click="stopTestLeader" :disabled="!toolStatus.running || !toolStatus.name?.startsWith('Test Leader')" class="flex-1 bg-red-600 hover:bg-red-700 disabled:opacity-50 text-xs py-1.5 rounded">
                            ğŸšª é€€å‡ºæˆ¿é—´
                        </button>
                    </div>
                </div>

            </nav>
            
            <div class="p-4 border-t border-gray-700 text-xs text-gray-500 text-center">
                Dota 2 Arcade Bot v6.0
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- é¡¶éƒ¨ Tab -->
            <div class="bg-gray-800 border-b border-gray-700 px-4 flex items-center">
                <!-- æ—¥å¿—é¡µç­¾ä¸‹æ‹‰èœå• -->
                <div class="relative group">
                    <button :class="currentTab.startsWith('log') ? 'border-blue-500 text-white' : 'border-transparent text-gray-400 hover:text-gray-200'" class="px-4 py-3 border-b-2 font-medium text-sm transition flex items-center">
                        è¿è¡Œæ—¥å¿— <span class="ml-1 text-xs">â–¼</span>
                    </button>
                    <div class="absolute left-0 top-full bg-gray-700 rounded shadow-lg z-20 hidden group-hover:block min-w-max">
                        <button @click="currentTab = 'log_showcase'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_showcase' ? 'text-blue-400' : 'text-gray-200'">ğŸ­ å±•ç¤ºè½¦é˜Ÿ</button>
                        <button @click="currentTab = 'log_farming'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_farming' ? 'text-blue-400' : 'text-gray-200'">ğŸŒ¾ æŒ‚æœºè½¦é˜Ÿ</button>
                        <button @click="currentTab = 'log_subscribe'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_subscribe' ? 'text-blue-400' : 'text-gray-200'">ğŸ—ºï¸ è®¢é˜…æ—¥å¿—</button>
                        <button @click="currentTab = 'log_query'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_query' ? 'text-blue-400' : 'text-gray-200'">ğŸ” æŸ¥è¯¢æ—¥å¿—</button>
                        <button @click="currentTab = 'log_proxy'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_proxy' ? 'text-blue-400' : 'text-gray-200'">ğŸ”Œ ä»£ç†æµ‹è¯•</button>
                        <button @click="currentTab = 'log_testleader'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_testleader' ? 'text-blue-400' : 'text-gray-200'">ğŸ‘‘ ä¸»å·æµ‹è¯•</button>
                    </div>
                </div>
                <button @click="loadConfig('showcase')" :class="currentTab === 'config_showcase' ? 'border-blue-500 text-white' : 'border-transparent text-gray-400 hover:text-gray-200'" class="px-4 py-3 border-b-2 font-medium text-sm transition">å±•ç¤ºé…ç½®</button>
                <button @click="loadConfig('leaders')" :class="currentTab === 'config_leaders' ? 'border-blue-500 text-white' : 'border-transparent text-gray-400 hover:text-gray-200'" class="px-4 py-3 border-b-2 font-medium text-sm transition">ä¸»å·é…ç½®</button>
                <button @click="showFarmConfigs()" :class="currentTab === 'farm_configs' ? 'border-blue-500 text-white' : 'border-transparent text-gray-400 hover:text-gray-200'" class="px-4 py-3 border-b-2 font-medium text-sm transition">Farmé…ç½®</button>
            </div>

            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="flex-1 bg-gray-900 overflow-hidden relative">
                
                <!-- æ—¥å¿— Tab -->
                <div v-show="currentTab.startsWith('log')" class="h-full flex flex-col p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-sm font-semibold text-gray-400">{{ logTabTitle }}</h2>
                        <button @click="clearCurrentLogs" class="text-xs text-gray-500 hover:text-white">æ¸…ç©ºæ—¥å¿—</button>
                    </div>
                    
                    <!-- Stats å›ºå®šæ˜¾ç¤ºåŒºï¼ˆä»…æŒ‚æœºæ—¥å¿—ï¼‰ - v4.0 è¯¦ç»†ç»Ÿè®¡ -->
                    <div v-if="currentTab === 'log_farming' && farmingProgress" class="bg-gray-800 border border-blue-500/50 rounded p-3 mb-2 text-sm">
                        <!-- ç¬¬ä¸€è¡Œï¼šå°å·çŠ¶æ€ -->
                        <div class="flex items-center flex-wrap gap-x-3 gap-y-1 mb-1">
                            <span class="text-blue-400 font-bold">ğŸ“Š æŒ‚æœºç»Ÿè®¡</span>
                            <span class="text-gray-400">æ€»:<span class="text-white font-bold">{{ farmingProgress.total }}</span></span>
                            <span class="text-gray-400">âœ…å…¥:<span class="text-green-400 font-bold">{{ farmingProgress.inLobby }}</span></span>
                            <span class="text-gray-400">â³åŠ :<span class="text-yellow-400">{{ farmingProgress.assigned }}</span></span>
                            <span class="text-gray-400">ğŸ’¤æ± :<span class="text-cyan-400">{{ farmingProgress.poolIdle }}</span></span>
                            <span class="text-gray-400">ğŸ”„ç™»:<span class="text-blue-300">{{ farmingProgress.loggingIn }}</span></span>
                            <span class="text-gray-400">ğŸ“‹é˜Ÿåˆ—:<span class="text-orange-400">{{ farmingProgress.queueLength }}</span></span>
                        </div>
                        <!-- ç¬¬äºŒè¡Œï¼šæˆ¿é—´/ä¸»å·/æ—¶é—´ -->
                        <div class="flex items-center flex-wrap gap-x-3 gap-y-1 text-xs border-t border-gray-700 pt-1">
                            <span class="text-gray-400">ğŸšªæˆ¿é—´:<span class="text-white">{{ farmingProgress.roomsCreated }}</span></span>
                            <span class="text-gray-400">ğŸ‘‘ä¸»å·:<span class="text-purple-400">{{ farmingProgress.leadersActive }}/{{ farmingProgress.leadersTotal }}</span></span>
                            <span class="text-gray-400">ğŸ“¦é…ç½®:<span class="text-gray-300">{{ farmingProgress.loadedConfigs?.join(', ') || 'config_000' }}</span></span>
                            <span class="text-gray-400">â±ï¸æ—¶é•¿:<span class="text-yellow-400 font-bold">{{ formatElapsed(farmingTotalElapsed) }}</span></span>
                            <span class="text-gray-400">è¿›åº¦:<span class="text-green-400 font-bold">{{ farmingProgress.percent }}%</span></span>
                        </div>
                    </div>
                    
                    <!-- Stats å›ºå®šæ˜¾ç¤ºåŒºï¼ˆä»…è®¢é˜…æ—¥å¿—ï¼‰ - v6.0 æ± å­æ¨¡å¼ -->
                    <div v-if="currentTab === 'log_subscribe' && subscribeProgress" class="bg-gray-800 border border-green-500/50 rounded p-3 mb-2 text-sm">
                        <div class="flex items-center flex-wrap gap-x-3 gap-y-1">
                            <span class="text-green-400 font-bold">ğŸ“¦ è®¢é˜…ç»Ÿè®¡</span>
                            <span class="text-gray-400">æ€»:<span class="text-white font-bold">{{ subscribeProgress.total }}</span></span>
                            <span class="text-gray-400">âœ…æˆåŠŸ:<span class="text-green-400 font-bold">{{ subscribeProgress.success }}</span></span>
                            <span class="text-gray-400">ğŸŠæ± å­:<span class="text-cyan-400">{{ subscribeProgress.pool }}</span></span>
                            <span class="text-gray-400">â³å¤„ç†:<span class="text-yellow-400">{{ subscribeProgress.processing }}</span></span>
                            <span class="text-gray-400">è¿›åº¦:<span class="text-green-400 font-bold">{{ subscribeProgress.percent }}%</span></span>
                            <span class="text-gray-400">â±ï¸æ—¶é•¿:<span class="text-yellow-400 font-bold">{{ subscribeProgress.elapsed }}s</span></span>
                        </div>
                    </div>
                    
                    <!-- Stats å›ºå®šæ˜¾ç¤ºåŒºï¼ˆä»…ä»£ç†æµ‹è¯•æ—¥å¿—ï¼‰ -->
                    <div v-if="currentTab === 'log_proxy' && proxyProgress" class="bg-gray-800 border border-orange-500/50 rounded p-3 mb-2 text-sm">
                        <div class="flex items-center flex-wrap gap-x-3 gap-y-1">
                            <span class="text-orange-400 font-bold">ğŸ”Œ ä»£ç†æµ‹è¯•</span>
                            <span class="text-gray-400">æ€»:<span class="text-white font-bold">{{ proxyProgress.total }}</span></span>
                            <span class="text-gray-400">âœ…æˆåŠŸ:<span class="text-green-400 font-bold">{{ proxyProgress.success }}</span></span>
                            <span class="text-gray-400">âŒå¤±è´¥:<span class="text-red-400 font-bold">{{ proxyProgress.failed }}</span></span>
                            <span class="text-gray-400">â³æµ‹è¯•ä¸­:<span class="text-yellow-400">{{ proxyProgress.pending }}</span></span>
                            <span class="text-gray-400">è¿›åº¦:<span class="text-green-400 font-bold">{{ proxyProgress.percent }}%</span></span>
                            <span class="text-gray-400">æˆåŠŸç‡:<span class="text-cyan-400 font-bold">{{ proxyProgress.successRate }}%</span></span>
                            <span class="text-gray-400">â±ï¸æ—¶é•¿:<span class="text-yellow-400 font-bold">{{ proxyProgress.elapsed }}s</span></span>
                            <button @click="replaceProxies()" class="ml-auto bg-green-600 hover:bg-green-500 text-white text-xs px-3 py-1 rounded">
                                âœ… æ›¿æ¢ä»£ç†é…ç½®
                            </button>
                        </div>
                    </div>
                    
                    <div ref="logContainer" class="log-window rounded border border-gray-700 flex-1 p-2">
                        <div v-for="(log, idx) in filteredLogs" :key="idx" class="log-entry" :class="`log-${log.type}`">
                            <span class="opacity-50">[{{ log.timestamp }}]</span>
                            <span class="font-bold mx-1">[{{ log.source }}]</span>
                            <span v-html="formatMessage(log.message)"></span>
                        </div>
                    </div>
                </div>

                <!-- JSON é…ç½® Tab (showcase/leaders) -->
                <div v-show="currentTab === 'config_showcase' || currentTab === 'config_leaders'" class="h-full flex flex-col p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-sm font-semibold text-gray-400">
                            {{ currentTab === 'config_showcase' ? 'config_showcase.json' : 'config_leaders.json' }}
                        </h2>
                        <div class="space-x-2">
                            <span v-if="saveMessage" class="text-xs text-green-500">{{ saveMessage }}</span>
                            <button @click="saveConfig()" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded">ä¿å­˜ä¿®æ”¹</button>
                        </div>
                    </div>
                    <textarea v-model="configContent" class="flex-1 bg-gray-800 border border-gray-700 rounded p-4 font-mono text-sm resize-none focus:outline-none focus:border-blue-500"></textarea>
                </div>
                
                <!-- Farm é…ç½®ç¼–è¾‘ Tab (æ–‡æœ¬æ ¼å¼) -->
                <div v-show="currentTab === 'config_farm'" class="h-full flex flex-col p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-sm font-semibold text-gray-400">
                            ğŸ“¦ {{ editingFarmConfig }} <span class="text-gray-500 text-xs">ï¼ˆæ ¼å¼ï¼šç”¨æˆ·å,å¯†ç ï¼‰</span>
                        </h2>
                        <div class="space-x-2">
                            <button @click="showFarmConfigs()" class="bg-gray-600 hover:bg-gray-500 text-white text-xs px-3 py-1 rounded">â† è¿”å›åˆ—è¡¨</button>
                            <span v-if="saveMessage" class="text-xs text-green-500">{{ saveMessage }}</span>
                            <button @click="saveFarmConfig()" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded">ä¿å­˜ä¿®æ”¹</button>
                        </div>
                    </div>
                    <div class="flex-1 flex flex-col min-h-0">
                        <!-- å°å·åˆ—è¡¨ -->
                        <div class="flex-1 flex flex-col">
                            <label class="text-xs text-gray-400 mb-1">ğŸ® å°å·åˆ—è¡¨ (followers.txt)</label>
                            <textarea v-model="farmFollowersContent" placeholder="ç”¨æˆ·å,å¯†ç &#10;ç”¨æˆ·å,å¯†ç &#10;..." class="flex-1 bg-gray-800 border border-gray-700 rounded p-3 font-mono text-xs resize-none focus:outline-none focus:border-blue-500"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Farm é…ç½®åˆ—è¡¨ Tab -->
                <div v-show="currentTab === 'farm_configs'" class="h-full flex flex-col p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-white">ğŸ“ Farm é…ç½®åˆ—è¡¨ <span class="text-xs text-gray-400 font-normal">(v4.0: ä»£ç†å·²ç§»è‡³ä¸»å·é…ç½®)</span></h2>
                        <div class="flex space-x-2">
                            <button @click="refreshFarmConfigs" class="bg-gray-600 hover:bg-gray-500 text-white text-xs px-3 py-1 rounded">ğŸ”„ åˆ·æ–°</button>
                            <button @click="addFarmConfig" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded">â• æ·»åŠ é…ç½®</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-800 sticky top-0">
                                <tr>
                                    <th class="text-left px-4 py-2 text-gray-400">é…ç½®å</th>
                                    <th class="text-right px-4 py-2 text-gray-400">å°å·æ•°</th>
                                    <th class="text-center px-4 py-2 text-gray-400">çŠ¶æ€</th>
                                    <th class="text-center px-4 py-2 text-gray-400">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="cfg in farmConfigs" :key="cfg.name" class="border-b border-gray-700 hover:bg-gray-800/50">
                                    <td class="px-4 py-3">
                                        <span class="font-mono">{{ cfg.name }}</span>
                                    </td>
                                    <td class="px-4 py-3 text-right text-gray-300">{{ cfg.followers }}</td>
                                    <td class="px-4 py-3 text-center">
                                        <span v-if="cfg.name === 'config_000'" class="text-xs bg-blue-600 px-2 py-0.5 rounded">é»˜è®¤</span>
                                        <span v-else-if="loadedFarmConfigs.has(cfg.name)" class="text-xs bg-green-600 px-2 py-0.5 rounded">å·²åŠ å…¥</span>
                                        <span v-else class="text-xs bg-gray-600 px-2 py-0.5 rounded">æœªåŠ å…¥</span>
                                    </td>
                                    <td class="px-4 py-3 text-center space-x-2">
                                        <button @click="editFarmConfig(cfg.name)" class="text-blue-400 hover:text-blue-300 text-xs">ç¼–è¾‘</button>
                                        <button v-if="cfg.name !== 'config_000' && !loadedFarmConfigs.has(cfg.name) && status.farming" 
                                                @click="addConfigToPool(cfg.name)" 
                                                class="text-green-400 hover:text-green-300 text-xs">åŠ å…¥æ± å­</button>
                                        <button v-if="cfg.name !== 'config_000' && loadedFarmConfigs.has(cfg.name) && status.farming"
                                                @click="removeConfigFromPool(cfg.name)"
                                                class="text-red-400 hover:text-red-300 text-xs">ç§»é™¤</button>
                                    </td>
                                </tr>
                                <tr v-if="farmConfigs.length === 0">
                                    <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                                        æš‚æ— é…ç½®ï¼Œç‚¹å‡»ã€Œæ·»åŠ é…ç½®ã€åˆ›å»º
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <!-- Steam Guard éªŒè¯ç å¼¹çª— -->
        <div v-if="steamGuardVisible" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50" @click.self="cancelSteamGuard">
            <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl border border-gray-700">
                <h3 class="text-lg font-semibold text-white mb-4">ğŸ” Steam Guard éªŒè¯</h3>
                <p class="text-sm text-gray-400 mb-4">éœ€è¦éªŒè¯ç  ({{ steamGuardDomain }})</p>
                <input 
                    v-model="steamGuardCode" 
                    @keyup.enter="submitSteamGuard"
                    type="text" 
                    placeholder="è¯·è¾“å…¥éªŒè¯ç "
                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white mb-4 focus:outline-none focus:border-blue-500"
                    autofocus
                >
                <div class="flex space-x-2">
                    <button @click="submitSteamGuard" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-medium transition">æäº¤</button>
                    <button @click="cancelSteamGuard" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded font-medium transition">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
        const socket = io();

        createApp({
            setup() {
                const status = ref({ showcase: false, farming: false });
                const toolStatus = ref({ running: false, name: null });
                
                // ç‹¬ç«‹æ—¥å¿—æ•°ç»„ï¼ˆæ¯ä¸ªåˆ†é¡µç‹¬ç«‹ç®¡ç†ï¼Œé¿å…äº’ç›¸æŒ¤å ï¼‰
                const showcaseLogs = ref([]);
                const farmingLogs = ref([]);
                // æ¸…ç†æ‰€æœ‰è¿›ç¨‹åŠŸèƒ½å·²ç§»é™¤ï¼ˆä¿ç•™å˜é‡ä¼šå¯¼è‡´æ— ç”¨é€»è¾‘ï¼Œè¿™é‡Œä¸€å¹¶åˆ é™¤ï¼‰
                const subscribeLogs = ref([]);
                const queryLogs = ref([]);
                const proxyLogs = ref([]);  // ä»£ç†æµ‹è¯•æ—¥å¿—
                const testLeaderLogs = ref([]);  // ä¸»å·æµ‹è¯•æ—¥å¿—
                const LOG_LIMIT = 1000;  // æ¯ä¸ªåˆ†é¡µçš„æ—¥å¿—ä¸Šé™
                
                // ä¸»å·æµ‹è¯•è¡¨å•
                const testLeader = ref({
                    username: '',
                    password: '',
                    proxy: '',
                    shared_secret: ''
                });
                
                const currentTab = ref('log_farming');
                const logContainer = ref(null);
                const farmingStats = ref(null); // æŒ‚æœºè½¦é˜Ÿå®æ—¶çŠ¶æ€ï¼ˆæ€»ä½“ï¼‰
                const farmingProgress = ref(null); // æŒ‚æœºè½¦é˜Ÿè¿›åº¦ä¿¡æ¯
                const subscribeProgress = ref(null); // è®¢é˜…è¿›åº¦ä¿¡æ¯
                const proxyProgress = ref(null); // ä»£ç†æµ‹è¯•è¿›åº¦ä¿¡æ¯
                let farmingElapsedTimer = null;   // æ—¶é—´æ›´æ–°å®šæ—¶å™¨
                let farmingTotalStartTime = null; // æ€»è¿è¡Œå¼€å§‹æ—¶é—´
                const farmingTotalElapsed = ref(0); // æ€»è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
                const farmingTotalFollowers = ref(0); // æ€»å°å·æ•°é‡
                
                // é…ç½®ç¼–è¾‘
                const configContent = ref('');
                const currentConfigType = ref(null);
                const saveMessage = ref('');

                // Farm é…ç½®åˆ—è¡¨
                const farmConfigs = ref([]);
                const editingFarmConfig = ref(null);
                const loadedFarmConfigs = ref(new Set(['config_000'])); // å·²åŠ å…¥æ± å­çš„é…ç½®ï¼ˆé»˜è®¤ config_000ï¼‰

                // å·¥å…·å‚æ•°
                const searchGameId = ref('');
                const queryGameId = ref('');
                const toolGameId = ref('');           // å·¥å…·ç®±å…±ç”¨çš„æ¸¸æˆID
                const subscribeConfigName = ref('');  // è®¢é˜…ç”¨çš„é…ç½®å

                // é¢†é˜Ÿåˆ—è¡¨
                const showcaseLeaders = ref([]);
                const selectedShowcaseLeader = ref('');
                const farmingLeaders = ref([]);
                const selectedFarmingLeader = ref('');
                const farmingLeadersStatus = ref({}); // username -> { stopped, state, is_gc_connected, ... }

                // Steam Guard éªŒè¯ç 
                const steamGuardVisible = ref(false);
                const steamGuardDomain = ref('');
                const steamGuardCode = ref('');
                const steamGuardKey = ref('');

                // è‡ªåŠ¨æ»šåŠ¨æ—¥å¿—
                const scrollToBottom = () => {
                    nextTick(() => {
                        if (logContainer.value) {
                            logContainer.value.scrollTop = logContainer.value.scrollHeight;
                        }
                    });
                };

                // æ—¥å¿—é¡µç­¾æ ‡é¢˜
                const logTabTitle = computed(() => {
                    const titles = {
                        'log_showcase': 'ğŸ­ å±•ç¤ºè½¦é˜Ÿæ—¥å¿—',
                        'log_farming': 'ğŸŒ¾ æŒ‚æœºè½¦é˜Ÿæ—¥å¿—',
                        'log_subscribe': 'ğŸ—ºï¸ è®¢é˜…æ—¥å¿—',
                        'log_query': 'ğŸ” æŸ¥è¯¢æ—¥å¿—',
                        'log_proxy': 'ğŸ”Œ ä»£ç†æµ‹è¯•æ—¥å¿—',
                        'log_testleader': 'ğŸ‘‘ ä¸»å·æµ‹è¯•æ—¥å¿—'
                    };
                    return titles[currentTab.value] || 'ç³»ç»Ÿæ—¥å¿—';
                });

                // ç›´æ¥è¿”å›å¯¹åº”åˆ†é¡µçš„æ—¥å¿—æ•°ç»„
                const filteredLogs = computed(() => {
                    switch (currentTab.value) {
                        case 'log_showcase': return showcaseLogs.value;
                        case 'log_farming': return farmingLogs.value;
                        case 'log_subscribe': return subscribeLogs.value;
                        case 'log_query': return queryLogs.value;
                        case 'log_proxy': return proxyLogs.value;
                        case 'log_testleader': return testLeaderLogs.value;
                        default: return farmingLogs.value;
                    }
                });
                
                // åˆ¤æ–­æ—¥å¿—å±äºå“ªä¸ªåˆ†é¡µï¼ˆæ ¹æ® source ç²¾ç¡®åŒ¹é…ï¼‰
                const getLogCategory = (log) => {
                    const src = log.source.toLowerCase();
                    const msg = log.message.toLowerCase();
                    
                    // å±•ç¤ºè½¦é˜Ÿ
                    if (src === 'showcase' || src === 'showcase-cleanup' ||
                        (src === 'system' && msg.includes('showcase'))) {
                        return 'showcase';
                    }
                    // æŒ‚æœºè½¦é˜Ÿ
                    if (src === 'farming' || src === 'farming-cleanup' || src === 'stats' ||
                        (src === 'system' && msg.includes('farming'))) {
                        return 'farming';
                    }
                    // è®¢é˜…æ—¥å¿—ï¼ˆç²¾ç¡®åŒ¹é… sourceï¼‰
                    if (src === 'subscribe_map' ||
                        (src === 'system' && msg.includes('subscribe_map'))) {
                        return 'subscribe';
                    }
                    // æŸ¥è¯¢æ—¥å¿—ï¼ˆç²¾ç¡®åŒ¹é… sourceï¼‰
                    if (src === 'list_lobbies' ||
                        (src === 'system' && msg.includes('list_lobbies'))) {
                        return 'query';
                    }
                    // ä»£ç†æµ‹è¯•æ—¥å¿—ï¼ˆç²¾ç¡®åŒ¹é… sourceï¼‰
                    if (src === 'test_proxies' ||
                        (src === 'system' && msg.includes('test_proxies'))) {
                        return 'proxy';
                    }
                    // ä¸»å·æµ‹è¯•æ—¥å¿—ï¼ˆç²¾ç¡®åŒ¹é… sourceï¼‰
                    if (src === 'test_leader' ||
                        (src === 'system' && msg.includes('test_leader'))) {
                        return 'testleader';
                    }
                    // é»˜è®¤å½’å…¥æŒ‚æœºè½¦é˜Ÿ
                    return 'farming';
                };
                
                // å°†æ—¥å¿—æ·»åŠ åˆ°å¯¹åº”åˆ†é¡µ
                const addLog = (log) => {
                    const category = getLogCategory(log);
                    let targetLogs;
                    switch (category) {
                        case 'showcase': targetLogs = showcaseLogs; break;
                        case 'farming': targetLogs = farmingLogs; break;
                        case 'subscribe': targetLogs = subscribeLogs; break;
                        case 'query': targetLogs = queryLogs; break;
                        case 'proxy': targetLogs = proxyLogs; break;
                        case 'testleader': targetLogs = testLeaderLogs; break;
                        default: targetLogs = farmingLogs;
                    }
                    targetLogs.value.push(log);
                    if (targetLogs.value.length > LOG_LIMIT) targetLogs.value.shift();
                };

                // æ¸…ç©ºå½“å‰é¡µç­¾æ—¥å¿—
                const clearCurrentLogs = () => {
                    switch (currentTab.value) {
                        case 'log_showcase': showcaseLogs.value = []; break;
                        case 'log_farming': farmingLogs.value = []; break;
                        case 'log_subscribe': subscribeLogs.value = []; break;
                        case 'log_query': queryLogs.value = []; break;
                        case 'log_proxy': proxyLogs.value = []; break;
                        case 'log_testleader': testLeaderLogs.value = []; break;
                    }
                };

                // æ ¼å¼åŒ–æ—¥å¿—æ¶ˆæ¯
                const formatMessage = (msg) => {
                    // è¯†åˆ«æ–‡ä»¶é“¾æ¥æ ‡è®°
                    if (msg.includes('[FILE_LINK]')) {
                        const filepath = msg.replace('[FILE_LINK]', '').trim();
                        const filename = filepath.split('\\').pop();
                        return `ç»“æœå·²ä¿å­˜åˆ°: <a href="/api/csv/${filename}" target="_blank" class="text-blue-400 hover:text-blue-300 underline">${filename}</a> ğŸ“¥`;
                    }
                    return msg.replace(/\n/g, '<br>');
                };

                // Socket ç›‘å¬
                onMounted(() => {
                    socket.on('log', (log) => {
                        addLog(log);  // åˆ†å‘åˆ°å¯¹åº”åˆ†é¡µ
                        scrollToBottom();
                        
                        // æå–æŒ‚æœºè½¦é˜Ÿ Stats ä¿¡æ¯ (v5.0 æµæ°´çº¿æ¨¡å¼)
                        // æ—¥å¿—æ ¼å¼: æ€»:300 âœ…å…¥:16 â³åŠ :1 ğŸ’¤æ± :283 ğŸ”„ç™»:0 ğŸ“‹é˜Ÿåˆ—:0 | ğŸšªæˆ¿:3 ğŸ‘‘ä¸»:1/1 | â±ï¸2åˆ†7ç§’ (5%)
                        if (log.source === 'farming' && log.message.includes('æ€»:') && log.message.includes('âœ…å…¥:')) {
                            const totalMatch = log.message.match(/æ€»:(\d+)/);
                            const inLobbyMatch = log.message.match(/âœ…å…¥:(\d+)/);
                            const assignedMatch = log.message.match(/â³åŠ :(\d+)/);
                            const poolMatch = log.message.match(/ğŸ’¤æ± :(\d+)/);
                            const loggingInMatch = log.message.match(/ğŸ”„ç™»:(\d+)/);
                            const queueMatch = log.message.match(/ğŸ“‹é˜Ÿåˆ—:(\d+)/);
                            const roomMatch = log.message.match(/ğŸšªæˆ¿:(\d+)/);
                            const leaderMatch = log.message.match(/ğŸ‘‘ä¸»:(\d+)\/(\d+)/);
                            const percentMatch = log.message.match(/\((\d+)%\)/);
                            
                            if (totalMatch && inLobbyMatch) {
                                farmingProgress.value = {
                                    total: parseInt(totalMatch[1]),
                                    inLobby: parseInt(inLobbyMatch[1]),
                                    assigned: assignedMatch ? parseInt(assignedMatch[1]) : 0,
                                    poolIdle: poolMatch ? parseInt(poolMatch[1]) : 0,
                                    loggingIn: loggingInMatch ? parseInt(loggingInMatch[1]) : 0,
                                    queueLength: queueMatch ? parseInt(queueMatch[1]) : 0,
                                    roomsCreated: roomMatch ? parseInt(roomMatch[1]) : 0,
                                    leadersActive: leaderMatch ? parseInt(leaderMatch[1]) : 0,
                                    leadersTotal: leaderMatch ? parseInt(leaderMatch[2]) : 0,
                                    percent: percentMatch ? parseInt(percentMatch[1]) : 0,
                                    loadedConfigs: loadedFarmConfigs.value ? Array.from(loadedFarmConfigs.value) : ['config_000']
                                };
                                
                                // æ›´æ–°æ€»æ•°
                                farmingTotalFollowers.value = parseInt(totalMatch[1]);
                            }
                        }
                        
                        // è½¦é˜Ÿåœæ­¢/æ¸…ç†å®Œæˆæ—¶ï¼Œæ¸…ç©º Stats
                        if (log.message.includes('è½¦é˜Ÿæ¸…ç†å®Œæˆ') || 
                            log.message.includes('è¿›ç¨‹å·²å®Œå…¨åœæ­¢') ||
                            log.message.includes('farming è¿›ç¨‹å·²é€€å‡º')) {
                            farmingStats.value = null;
                            farmingProgress.value = null;
                        }
                        
                        // è§£æè®¢é˜…ç»Ÿè®¡æ—¥å¿— - v6.0 æ± å­æ¨¡å¼
                        // [Stats] æ€»:2000 | âœ…æˆåŠŸ:123 | ğŸŠæ± å­:1800 | â³å¤„ç†:77 | è¿›åº¦:6.4% | â±ï¸30s
                        if (log.source === 'subscribe_map' && log.message.includes('[Stats]')) {
                            const totalMatch = log.message.match(/æ€»:(\d+)/);
                            const successMatch = log.message.match(/æˆåŠŸ:(\d+)/);
                            const poolMatch = log.message.match(/æ± å­:(\d+)/);
                            const processingMatch = log.message.match(/å¤„ç†:(\d+)/);
                            const percentMatch = log.message.match(/è¿›åº¦:([\d.]+)%/);
                            const elapsedMatch = log.message.match(/â±ï¸(\d+)s/);
                            
                            if (totalMatch) {
                                subscribeProgress.value = {
                                    total: parseInt(totalMatch[1]),
                                    success: successMatch ? parseInt(successMatch[1]) : 0,
                                    pool: poolMatch ? parseInt(poolMatch[1]) : 0,
                                    processing: processingMatch ? parseInt(processingMatch[1]) : 0,
                                    percent: percentMatch ? percentMatch[1] : '0',
                                    elapsed: elapsedMatch ? elapsedMatch[1] : '0'
                                };
                            }
                        }
                        
                        // è§£æä»£ç†æµ‹è¯•ç»Ÿè®¡æ—¥å¿—
                        // [Stats] æ€»:2500 | âœ…æˆåŠŸ:2000 | âŒå¤±è´¥:300 | â³æµ‹è¯•ä¸­:200 | è¿›åº¦:92.0% | â±ï¸120s
                        if (log.source === 'test_proxies' && log.message.includes('[Stats]')) {
                            const totalMatch = log.message.match(/æ€»:(\d+)/);
                            const successMatch = log.message.match(/æˆåŠŸ:(\d+)/);
                            const failedMatch = log.message.match(/å¤±è´¥:(\d+)/);
                            const pendingMatch = log.message.match(/æµ‹è¯•ä¸­:(\d+)/);
                            const percentMatch = log.message.match(/è¿›åº¦:([\d.]+)%/);
                            const elapsedMatch = log.message.match(/â±ï¸(\d+)s/);
                            
                            if (totalMatch) {
                                const total = parseInt(totalMatch[1]);
                                const success = successMatch ? parseInt(successMatch[1]) : 0;
                                const completed = success + (failedMatch ? parseInt(failedMatch[1]) : 0);
                                const successRate = completed > 0 ? ((success / completed) * 100).toFixed(1) : '0';
                                
                                proxyProgress.value = {
                                    total: total,
                                    success: success,
                                    failed: failedMatch ? parseInt(failedMatch[1]) : 0,
                                    pending: pendingMatch ? parseInt(pendingMatch[1]) : 0,
                                    percent: percentMatch ? percentMatch[1] : '0',
                                    successRate: successRate,
                                    elapsed: elapsedMatch ? elapsedMatch[1] : '0'
                                };
                            }
                        }
                        
                        // å·¥å…·è¿›ç¨‹é€€å‡ºæ—¶æ¸…é™¤è¿›åº¦
                        if (log.source === 'System' && log.message.includes('subscribe_map è¿›ç¨‹å·²é€€å‡º')) {
                            subscribeProgress.value = null;
                        }
                        if (log.source === 'System' && log.message.includes('test_proxies è¿›ç¨‹å·²é€€å‡º')) {
                            proxyProgress.value = null;
                        }
                    });

                    socket.on('status', (newStatus) => {
                        status.value = { ...status.value, ...newStatus };
                        
                        // æŒ‚æœºè½¦é˜Ÿå¯åŠ¨æ—¶ï¼Œå¯åŠ¨æ—¶é—´æ›´æ–°å®šæ—¶å™¨
                        if (newStatus.farming === true && !farmingElapsedTimer) {
                            farmingTotalStartTime = Date.now();
                            farmingTotalElapsed.value = 0;
                            farmingTotalFollowers.value = 0;
                            loadedFarmConfigs.value = new Set(['config_000']); // é‡ç½®å·²åŠ è½½é…ç½®
                            
                            farmingElapsedTimer = setInterval(() => {
                                // æ›´æ–°æ€»è¿è¡Œæ—¶é—´
                                if (farmingTotalStartTime) {
                                    farmingTotalElapsed.value = Math.floor((Date.now() - farmingTotalStartTime) / 1000);
                                }
                            }, 1000);
                        }
                        
                        // æŒ‚æœºè½¦é˜Ÿåœæ­¢æ—¶ï¼Œæ¸…ç©º Stats å’Œå®šæ—¶å™¨
                        if (newStatus.farming === false) {
                            farmingStats.value = null;
                            farmingProgress.value = null;
                            farmingTotalStartTime = null;
                            farmingLeadersStatus.value = {};
                            if (farmingElapsedTimer) {
                                clearInterval(farmingElapsedTimer);
                                farmingElapsedTimer = null;
                            }
                        }
                        
                        // æŒ‚æœºè½¦é˜Ÿå¯åŠ¨åï¼Œæ‹‰ä¸€æ¬¡ä¸»å·çŠ¶æ€
                        if (newStatus.farming === true) {
                            refreshFarmingLeadersStatus();
                        }
                    });

                    // farming ä¸»å·çŠ¶æ€æ¨é€ï¼ˆæ¥è‡ª server.js è½¬å‘ï¼‰
                    socket.on('farmingLeadersStatus', (payload) => {
                        const list = payload?.data || [];
                        const map = {};
                        list.forEach(item => {
                            if (item && item.username) {
                                map[item.username] = item;
                            }
                        });
                        farmingLeadersStatus.value = map;
                    });
                    
                    socket.on('toolStatus', (newToolStatus) => {
                        toolStatus.value = newToolStatus;
                    });

                    // è·å–åˆå§‹çŠ¶æ€
                    fetch('/api/status').then(r => r.json()).then(res => {
                        status.value = { showcase: res.showcase, farming: res.farming };
                        toolStatus.value = res.tool;
                    });

                    // ç›‘å¬ Steam Guard è¯·æ±‚
                    socket.on('needSteamGuard', ({ key, domain }) => {
                        steamGuardVisible.value = true;
                        steamGuardDomain.value = domain;
                        steamGuardKey.value = key;
                        steamGuardCode.value = '';
                    });

                    // åŠ è½½é¢†é˜Ÿåˆ—è¡¨
                    loadLeaders();
                    
                    // åŸç”Ÿäº‹ä»¶ç›‘å¬ï¼šåœæ­¢è®¢é˜…æŒ‰é’®ï¼ˆè§£å†³ Vue äº‹ä»¶ç»‘å®šé—®é¢˜ï¼‰
                    document.addEventListener('click', async (e) => {
                        if (e.target && (e.target.id === 'stopSubscribeBtn' || e.target.closest('#stopSubscribeBtn'))) {
                            console.log('[DEBUG] åœæ­¢è®¢é˜…æŒ‰é’®è¢«ç‚¹å‡»');
                            try {
                                const resp = await fetch('/api/tool/stop', { method: 'POST' });
                                const data = await resp.json();
                                console.log('[DEBUG] stopTool response:', resp.status, data);
                            } catch (err) {
                                console.error('åœæ­¢å·¥å…·å¤±è´¥:', err);
                            }
                        }
                    });
                });

                // API è°ƒç”¨
                const toggleProcess = async (name, action) => {
                    // åˆ‡æ¢åˆ°å¯¹åº”è½¦é˜Ÿçš„æ—¥å¿—é¡µç­¾ï¼ˆå¯åŠ¨å’Œåœæ­¢éƒ½åœ¨åŒä¸€ä¸ªé¡µç­¾ï¼‰
                    currentTab.value = name === 'showcase' ? 'log_showcase' : 'log_farming';
                    try {
                        await fetch(`/api/process/${name}/${action}`, { method: 'POST' });
                    } catch (e) {
                        addLog({ timestamp: '', source: 'System', message: `API Error: ${e.message}`, type: 'error' });
                    }
                };

                // è®¢é˜…åœ°å›¾ï¼ˆå•ç‹¬æ–¹æ³•ï¼Œç¡®ä¿å‚æ•°æ­£ç¡®ä¼ é€’ï¼‰
                const subscribeMap = () => {
                    const configName = subscribeConfigName.value;
                    const gameId = toolGameId.value;
                    console.log('subscribeMap:', configName, gameId);
                    runTool('subscribe_map', { configName, gameId });
                };
                
                // åœæ­¢å·¥å…·
                const stopTool = async () => {
                    console.log('[DEBUG] stopTool called');
                    try {
                        const resp = await fetch('/api/tool/stop', { method: 'POST' });
                        const data = await resp.json();
                        console.log('[DEBUG] stopTool response:', resp.status, data);
                    } catch (e) {
                        console.error('åœæ­¢å·¥å…·å¤±è´¥:', e);
                    }
                };
                
                // æ›¿æ¢ä»£ç†é…ç½®ï¼ˆç”¨æµ‹è¯•æˆåŠŸçš„ä»£ç†ï¼‰
                const replaceProxies = async () => {
                    if (!confirm(`ç¡®å®šè¦ç”¨æµ‹è¯•æˆåŠŸçš„ä»£ç†æ›¿æ¢ config_leaders.json ä¸­çš„ä»£ç†åˆ—è¡¨å—ï¼Ÿ\n\næˆåŠŸä»£ç†æ•°: ${proxyProgress.value?.success || 0}`)) {
                        return;
                    }
                    try {
                        const resp = await fetch('/api/proxy/replace', { method: 'POST' });
                        const data = await resp.json();
                        if (data.success) {
                            alert(`âœ… æ›¿æ¢æˆåŠŸï¼\n\nåŸä»£ç†æ•°: ${data.originalCount}\næ–°ä»£ç†æ•°: ${data.newCount}`);
                        } else {
                            alert('âŒ æ›¿æ¢å¤±è´¥: ' + data.error);
                        }
                    } catch (e) {
                        alert('âŒ è¯·æ±‚å¤±è´¥: ' + e.message);
                    }
                };
                
                // æµ‹è¯•æŒ‚æœºä¸»å·ï¼šåˆ›å»ºæˆ¿é—´
                const startTestLeader = async () => {
                    if (!testLeader.value.username || !testLeader.value.password) {
                        alert('è¯·è¾“å…¥è´¦å·å’Œå¯†ç ');
                        return;
                    }
                    if (!toolGameId.value) {
                        alert('è¯·å…ˆåœ¨ä¸Šæ–¹ã€Œæ¸¸æˆIDã€è¾“å…¥æ¡†å¡«å†™æ¸¸æˆID');
                        return;
                    }
                    currentTab.value = 'log_testleader';
                    try {
                        const res = await fetch('/api/tool/test_leader', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                username: testLeader.value.username,
                                password: testLeader.value.password,
                                proxy: testLeader.value.proxy || undefined,
                                shared_secret: testLeader.value.shared_secret || undefined,
                                gameId: toolGameId.value
                            })
                        });
                        if (!res.ok) {
                            const err = await res.json();
                            alert('æ“ä½œå¤±è´¥: ' + err.error);
                        }
                    } catch (e) {
                        alert('è¯·æ±‚å¤±è´¥: ' + e.message);
                    }
                };
                
                // æµ‹è¯•æŒ‚æœºä¸»å·ï¼šé€€å‡ºæˆ¿é—´
                const stopTestLeader = async () => {
                    try {
                        // å‘é€ "leave" å‘½ä»¤åˆ° stdin
                        const resp = await fetch('/api/tool/stop', { method: 'POST' });
                        const data = await resp.json();
                        console.log('åœæ­¢æµ‹è¯•ä¸»å·:', data);
                    } catch (e) {
                        alert('åœæ­¢å¤±è´¥: ' + e.message);
                    }
                };

                const runTool = async (name, body = {}) => {
                    // æ ¹æ®å·¥å…·ç±»å‹åˆ‡æ¢åˆ°å¯¹åº”æ—¥å¿—é¡µç­¾
                    if (name === 'subscribe_map') {
                        currentTab.value = 'log_subscribe';
                    } else if (name === 'list_lobbies') {
                        currentTab.value = 'log_query';
                    } else if (name === 'test_proxies') {
                        currentTab.value = 'log_proxy';
                    } else {
                        currentTab.value = 'log_farming';
                    }
                    try {
                        const res = await fetch(`/api/tool/${name}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });
                        if (!res.ok) {
                            const err = await res.json();
                            alert('æ“ä½œå¤±è´¥: ' + err.error);
                        }
                    } catch (e) {
                        alert('è¯·æ±‚å¤±è´¥');
                    }
                };

                const loadLeaders = async () => {
                    try {
                        // åŠ è½½å±•ç¤ºè½¦é˜Ÿé¢†é˜Ÿ
                        const showcaseRes = await fetch('/api/config/showcase');
                        const showcaseData = await showcaseRes.json();
                        showcaseLeaders.value = showcaseData.showcase_leaders || [];

                        // åŠ è½½æŒ‚æœºè½¦é˜Ÿä¸»å·ï¼ˆæ¥è‡ª config_leaders.jsonï¼‰
                        const leadersRes = await fetch('/api/config/leaders');
                        const leadersData = await leadersRes.json();
                        farmingLeaders.value = leadersData.leaders || [];
                        
                        // å¦‚æœæŒ‚æœºè½¦é˜Ÿåœ¨è¿è¡Œï¼Œé¡ºä¾¿æ‹‰ä¸€æ¬¡ä¸»å·çŠ¶æ€ï¼ˆç”¨äºæ˜¾ç¤ºâ€œå·²åœæ­¢/è¿è¡Œä¸­â€ï¼‰
                        if (status.value?.farming) {
                            refreshFarmingLeadersStatus();
                        }
                        
                        // åŠ è½½æµ‹è¯•é¡¹ç›® ID
                        if (showcaseData.global_settings && showcaseData.global_settings.custom_game_id) {
                            queryGameId.value = showcaseData.global_settings.custom_game_id;
                        }
                    } catch (e) {
                        console.error('åŠ è½½é¢†é˜Ÿåˆ—è¡¨å¤±è´¥', e);
                    }
                };

                // ğŸ”´ æ–°å¢ï¼šåœæ­¢æŒ‡å®šæŒ‚æœºä¸»å·
                const stopFarmingLeader = async (username) => {
                    if (!username) return;
                    if (!confirm(`ç¡®å®šåœæ­¢æŒ‚æœºä¸»å·ï¼š${username}ï¼Ÿ\n\nè¯¥ä¸»å·ä¼šé€€å‡ºæŒ‚æœºæµç¨‹å¹¶ç™»å‡ºã€‚`)) return;
                    currentTab.value = 'log_farming';
                    try {
                        const res = await fetch('/api/farming/stop_leader', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, mode: 'immediate' })
                        });
                        if (!res.ok) {
                            const err = await res.json();
                            alert('æ“ä½œå¤±è´¥: ' + err.error);
                        } else {
                            await refreshFarmingLeadersStatus();
                        }
                    } catch (e) {
                        alert('è¯·æ±‚å¤±è´¥: ' + e.message);
                    }
                };

                // ğŸ”´ æ–°å¢ï¼šå¯åŠ¨æŒ‡å®šæŒ‚æœºä¸»å·ï¼ˆåŠ å›æµç¨‹ï¼‰
                const startFarmingLeader = async (username) => {
                    if (!username) return;
                    if (!confirm(`ç¡®å®šå¯åŠ¨æŒ‚æœºä¸»å·ï¼š${username}ï¼Ÿ\n\nè¯¥ä¸»å·ä¼šé‡æ–°åŠ å…¥æŒ‚æœºæµç¨‹ã€‚`)) return;
                    currentTab.value = 'log_farming';
                    try {
                        const res = await fetch('/api/farming/start_leader', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username })
                        });
                        if (!res.ok) {
                            const err = await res.json();
                            alert('æ“ä½œå¤±è´¥: ' + err.error);
                        } else {
                            await refreshFarmingLeadersStatus();
                        }
                    } catch (e) {
                        alert('è¯·æ±‚å¤±è´¥: ' + e.message);
                    }
                };

                // ğŸ”´ æ–°å¢ï¼šåˆ·æ–°æŒ‚æœºä¸»å·çŠ¶æ€ï¼ˆä» farming è¿›ç¨‹è·å–ï¼‰
                const refreshFarmingLeadersStatus = async () => {
                    try {
                        const res = await fetch('/api/farming/leaders_status');
                        if (!res.ok) return;
                        const json = await res.json();
                        const list = json?.data || [];
                        const map = {};
                        list.forEach(item => {
                            if (item && item.username) {
                                map[item.username] = item;
                            }
                        });
                        farmingLeadersStatus.value = map;
                    } catch (e) {
                        // å¿½ç•¥é”™è¯¯ï¼Œä¸å½±å“ä¸»ç•Œé¢
                    }
                };

                // é€‰é¡¹å±•ç¤ºï¼šç”¨æˆ·å + çŠ¶æ€
                const formatFarmingLeaderOption = (username) => {
                    const st = farmingLeadersStatus.value?.[username];
                    if (!st) return username;
                    return `${username} (${st.stopped ? 'å·²åœæ­¢' : 'è¿è¡Œä¸­'})`;
                };

                const isSelectedFarmingLeaderStopped = computed(() => {
                    const u = selectedFarmingLeader.value;
                    if (!u) return false;
                    const st = farmingLeadersStatus.value?.[u];
                    return !!st?.stopped;
                });

                const verifyLeader = async (type, username) => {
                    if (!username) return;
                    currentTab.value = 'log_showcase';
                    try {
                        const res = await fetch(`/api/tool/login_leader`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ type, username })
                        });
                        if (!res.ok) {
                            const err = await res.json();
                            alert('æ“ä½œå¤±è´¥: ' + err.error);
                        }
                    } catch (e) {
                        alert('è¯·æ±‚å¤±è´¥');
                    }
                };

                // Farm é…ç½®ç›¸å…³æ–¹æ³•
                const refreshFarmConfigs = async () => {
                    try {
                        const res = await fetch('/api/farm/configs');
                        const data = await res.json();
                        farmConfigs.value = data.configs || [];
                    } catch (e) {
                        console.error('åŠ è½½ Farm é…ç½®å¤±è´¥', e);
                    }
                };

                const showFarmConfigs = () => {
                    currentTab.value = 'farm_configs';
                    refreshFarmConfigs();
                };

                const addFarmConfig = async () => {
                    // è‡ªåŠ¨ç”Ÿæˆä¸‹ä¸€ä¸ªé…ç½®å
                    const existingNums = farmConfigs.value.map(c => {
                        const match = c.name.match(/config_(\d+)/);
                        return match ? parseInt(match[1]) : -1;
                    });
                    const nextNum = existingNums.length > 0 ? Math.max(...existingNums) + 1 : 0;
                    const newName = `config_${String(nextNum).padStart(3, '0')}`;
                    
                    if (!confirm(`åˆ›å»ºæ–°é…ç½®: ${newName}ï¼Ÿ`)) return;
                    
                    try {
                        const res = await fetch('/api/farm/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: newName })
                        });
                        if (res.ok) {
                            refreshFarmConfigs();
                            editFarmConfig(newName);
                        } else {
                            const err = await res.json();
                            alert('åˆ›å»ºå¤±è´¥: ' + err.error);
                        }
                    } catch (e) {
                        alert('è¯·æ±‚å¤±è´¥');
                    }
                };

                // Farm é…ç½®ç¼–è¾‘ï¼ˆv4.0: åªæœ‰ followersï¼‰
                const farmFollowersContent = ref('');
                
                const editFarmConfig = async (name) => {
                    currentTab.value = 'config_farm';
                    currentConfigType.value = `farm/${name}`;
                    editingFarmConfig.value = name;
                    saveMessage.value = '';
                    try {
                        const res = await fetch(`/api/farm/config/${name}`);
                        const data = await res.json();
                        farmFollowersContent.value = data.followers || '';
                    } catch (e) {
                        farmFollowersContent.value = '// åŠ è½½å¤±è´¥';
                    }
                };
                
                const saveFarmConfig = async () => {
                    if (!editingFarmConfig.value) return;
                    try {
                        const res = await fetch(`/api/farm/config/${editingFarmConfig.value}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                followers: farmFollowersContent.value
                            })
                        });
                        
                        if (res.ok) {
                            saveMessage.value = 'ä¿å­˜æˆåŠŸ!';
                            setTimeout(() => saveMessage.value = '', 3000);
                        } else {
                            alert('ä¿å­˜å¤±è´¥');
                        }
                    } catch (e) {
                        alert('è¯·æ±‚å¤±è´¥');
                    }
                };

                // å°†é…ç½®åŠ å…¥å°å·æ± å­ (v4.0 æ–°å¢)
                const addConfigToPool = async (configName) => {
                    if (!confirm(`ç¡®å®šå°† ${configName} çš„å°å·åŠ å…¥æ± å­ï¼Ÿ`)) return;
                    try {
                        const res = await fetch('/api/farm/add_to_pool', { 
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ configName })
                        });
                        if (res.ok) {
                            loadedFarmConfigs.value.add(configName);
                            // è§¦å‘å“åº”å¼æ›´æ–°
                            loadedFarmConfigs.value = new Set(loadedFarmConfigs.value);
                        } else {
                            const err = await res.json();
                            alert('æ“ä½œå¤±è´¥: ' + err.error);
                        }
                    } catch (e) {
                        alert('è¯·æ±‚å¤±è´¥');
                    }
                };

                // ğŸ”´ æ–°å¢ï¼šå°†é…ç½®ä»å°å·æ± å­ç§»é™¤ï¼ˆé€€æˆ¿â†’ç™»å‡ºâ†’é€€å‡ºæ± å­ï¼‰
                const removeConfigFromPool = async (configName) => {
                    if (!confirm(`ç¡®å®šå°† ${configName} ä»æ± å­ç§»é™¤ï¼Ÿ\n\næ³¨æ„ï¼šä¼šè®©è¯¥é…ç½®å·²ç™»å½•çš„å°å·é€€å‡ºæˆ¿é—´å¹¶ç™»å‡ºã€‚`)) return;
                    try {
                        const res = await fetch('/api/farm/remove_from_pool', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ configName })
                        });
                        if (res.ok) {
                            loadedFarmConfigs.value.delete(configName);
                            loadedFarmConfigs.value = new Set(loadedFarmConfigs.value);
                        } else {
                            const err = await res.json();
                            alert('æ“ä½œå¤±è´¥: ' + err.error);
                        }
                    } catch (e) {
                        alert('è¯·æ±‚å¤±è´¥');
                    }
                };

                // æ ¼å¼åŒ–è¿è¡Œæ—¶é—´
                const formatElapsed = (seconds) => {
                    if (!seconds) return '0ç§’';
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    const s = seconds % 60;
                    if (h > 0) return `${h}æ—¶${m}åˆ†`;
                    if (m > 0) return `${m}åˆ†${s}ç§’`;
                    return `${s}ç§’`;
                };

                const submitSteamGuard = () => {
                    if (!steamGuardCode.value.trim()) {
                        alert('è¯·è¾“å…¥éªŒè¯ç ');
                        return;
                    }
                    socket.emit('submitSteamGuard', { 
                        key: steamGuardKey.value, 
                        code: steamGuardCode.value.trim() 
                    });
                    steamGuardVisible.value = false;
                };

                const cancelSteamGuard = () => {
                    steamGuardVisible.value = false;
                };

                const loadConfig = async (type) => {
                    currentTab.value = `config_${type}`;
                    currentConfigType.value = type;
                    editingFarmConfig.value = null;
                    saveMessage.value = '';
                    try {
                        const res = await fetch(`/api/config/${type}`);
                        const data = await res.json();
                        configContent.value = JSON.stringify(data, null, 2);
                    } catch (e) {
                        configContent.value = '// åŠ è½½å¤±è´¥';
                    }
                };

                const saveConfig = async () => {
                    try {
                        const json = JSON.parse(configContent.value);
                        
                        // åˆ¤æ–­æ˜¯å¦æ˜¯ farm é…ç½®
                        let url;
                        if (currentConfigType.value && currentConfigType.value.startsWith('farm/')) {
                            const name = currentConfigType.value.replace('farm/', '');
                            url = `/api/farm/config/${name}`;
                        } else {
                            url = `/api/config/${currentConfigType.value}`;
                        }
                        
                        const res = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(json)
                        });
                        
                        if (res.ok) {
                            saveMessage.value = 'ä¿å­˜æˆåŠŸ!';
                            setTimeout(() => saveMessage.value = '', 3000);
                        } else {
                            alert('ä¿å­˜å¤±è´¥');
                        }
                    } catch (e) {
                        alert('JSON æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥');
                    }
                };

                return {
                    status, toolStatus, currentTab, logContainer,
                    toggleProcess, runTool, subscribeMap, stopTool, formatMessage,
                    configContent, loadConfig, saveConfig, saveMessage,
                    searchGameId, queryGameId, toolGameId, subscribeConfigName,
                    showcaseLeaders, selectedShowcaseLeader,
                    farmingLeaders, selectedFarmingLeader, stopFarmingLeader, startFarmingLeader,
                    refreshFarmingLeadersStatus, formatFarmingLeaderOption, isSelectedFarmingLeaderStopped,
                    loadLeaders, verifyLeader,
                    steamGuardVisible, steamGuardDomain, steamGuardCode, 
                    submitSteamGuard, cancelSteamGuard,
                    // æ—¥å¿—é¡µç­¾ç›¸å…³ï¼ˆç‹¬ç«‹æ•°ç»„ï¼‰
                    logTabTitle, filteredLogs, clearCurrentLogs, farmingStats,
                    farmingTotalElapsed, farmingTotalFollowers,
                    // Farm é…ç½®ç›¸å…³
                    farmConfigs, farmingProgress, editingFarmConfig, loadedFarmConfigs,
                    farmFollowersContent,
                    refreshFarmConfigs, showFarmConfigs, addFarmConfig, editFarmConfig,
                    saveFarmConfig, addConfigToPool, formatElapsed,
                    removeConfigFromPool,
                    // å·¥å…·è¿›åº¦
                    subscribeProgress, proxyProgress, replaceProxies,
                    // ä¸»å·æµ‹è¯•
                    testLeader, startTestLeader, stopTestLeader
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
