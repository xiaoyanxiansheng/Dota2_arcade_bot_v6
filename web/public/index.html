<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dota 2 Bot æ§åˆ¶å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .log-window {
            height: 500px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
        }
        .log-entry { margin: 2px 0; border-bottom: 1px solid #333; padding: 2px 5px; }
        .log-info { color: #d4d4d4; }
        .log-success { color: #4ade80; }
        .log-warning { color: #facc15; }
        .log-error { color: #f87171; }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex flex-col overflow-hidden">
    <div id="app" class="flex h-full">
        
        <!-- ä¾§è¾¹æ  -->
        <div class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col">
            <div class="p-4 font-bold text-xl border-b border-gray-700 flex items-center">
                <span class="text-blue-500 mr-2">ğŸ¤–</span> Dota 2 Bot
            </div>
            
            <nav class="flex-1 overflow-y-auto p-2 space-y-2">
                <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">æ§åˆ¶é¢æ¿</div>
                
                <!-- å±•ç¤ºè½¦é˜Ÿ -->
                <div class="bg-gray-700/50 rounded p-3 mb-2">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium">å±•ç¤ºè½¦é˜Ÿ</span>
                        <span :class="status.showcase ? 'bg-green-500' : 'bg-red-500'" class="w-2 h-2 rounded-full"></span>
                    </div>
                    <div class="flex space-x-2 mb-2">
                        <button @click="toggleProcess('showcase', 'start')" :disabled="status.showcase" class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-xs py-1 px-2 rounded transition">å¯åŠ¨</button>
                        <button @click="toggleProcess('showcase', 'stop')" :disabled="!status.showcase" class="flex-1 bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed text-xs py-1 px-2 rounded transition">åœæ­¢</button>
                    </div>
                    <div class="border-t border-gray-600 pt-2 mt-2">
                        <label class="text-xs text-gray-400 block mb-1">å¤§å·éªŒè¯</label>
                        <select v-model="selectedShowcaseLeader" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs mb-1">
                            <option value="">-- é€‰æ‹©è´¦å· --</option>
                            <option v-for="(leader, idx) in showcaseLeaders" :key="idx" :value="leader.username">{{ leader.username }}</option>
                        </select>
                        <button @click="verifyLeader('showcase', selectedShowcaseLeader)" :disabled="!selectedShowcaseLeader || toolStatus.running" class="w-full bg-gray-600 hover:bg-gray-500 disabled:opacity-50 text-xs py-1 rounded">éªŒè¯</button>
                    </div>
                </div>

                <!-- æŒ‚æœºè½¦é˜Ÿ -->
                <div class="bg-gray-700/50 rounded p-3 mb-2">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium">æŒ‚æœºè½¦é˜Ÿ</span>
                        <span :class="status.farming ? 'bg-green-500' : 'bg-red-500'" class="w-2 h-2 rounded-full"></span>
                    </div>
                    <div class="flex space-x-2 mb-2">
                        <button @click="toggleProcess('farming', 'start')" :disabled="status.farming" class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-xs py-1 px-2 rounded transition">å¯åŠ¨</button>
                        <button @click="toggleProcess('farming', 'stop')" :disabled="!status.farming" class="flex-1 bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed text-xs py-1 px-2 rounded transition">åœæ­¢</button>
                    </div>
                    <div class="border-t border-gray-600 pt-2 mt-2">
                        <label class="text-xs text-gray-400 block mb-1">å¤§å·éªŒè¯</label>
                        <select v-model="selectedFarmingLeader" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs mb-1">
                            <option value="">-- é€‰æ‹©è´¦å· --</option>
                            <option v-for="(leader, idx) in farmingLeaders" :key="idx" :value="leader.username">{{ leader.username }}</option>
                        </select>
                        <button @click="verifyLeader('farming', selectedFarmingLeader)" :disabled="!selectedFarmingLeader || toolStatus.running" class="w-full bg-gray-600 hover:bg-gray-500 disabled:opacity-50 text-xs py-1 rounded">éªŒè¯</button>
                    </div>
                </div>

                <!-- å…¨å±€æ“ä½œ -->
                <button @click="runTool('clear_all')" class="w-full bg-red-800 hover:bg-red-700 text-white py-2 rounded text-sm font-medium mb-4 flex items-center justify-center">
                    <span v-if="toolStatus.running && toolStatus.name === 'Clear All'" class="animate-spin mr-2">â³</span>
                    ğŸ§¹ æ¸…ç†æ‰€æœ‰è¿›ç¨‹
                </button>

                <div class="border-t border-gray-700 my-2"></div>
                <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">å·¥å…·ç®±</div>

                <!-- è®¢é˜…åœ°å›¾ -->
                <button @click="runTool('subscribe_map')" :disabled="toolStatus.running" class="w-full bg-gray-600 hover:bg-gray-500 disabled:opacity-50 text-xs py-2 rounded mb-2 flex items-center justify-center">
                    <span v-if="toolStatus.running && toolStatus.name === 'Subscribe Maps'" class="animate-spin mr-2">â³</span>
                    ğŸ—ºï¸ æ‰¹é‡è®¢é˜…åœ°å›¾
                </button>

                <!-- æŸ¥è¯¢æˆ¿é—´ -->
                <div class="space-y-2">
                    <label class="text-xs text-gray-400">æŸ¥è¯¢æˆ¿é—´ (æµ‹è¯•é¡¹ç›®:{{ queryGameId || 'å…¨éƒ¨' }})</label>
                    <input v-model="searchGameId" placeholder="ç•™ç©ºæŸ¥æ‰€æœ‰" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs">
                    <button @click="runTool('list_lobbies', { gameId: searchGameId })" :disabled="toolStatus.running" class="w-full bg-gray-600 hover:bg-gray-500 disabled:opacity-50 text-xs py-1 rounded flex items-center justify-center">
                        <span v-if="toolStatus.running && toolStatus.name === 'List Lobbies'" class="animate-spin mr-2">â³</span>
                        ğŸ” æŸ¥è¯¢
                    </button>
                </div>

            </nav>
            
            <div class="p-4 border-t border-gray-700 text-xs text-gray-500 text-center">
                Dota 2 Arcade Bot v6.0
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- é¡¶éƒ¨ Tab -->
            <div class="bg-gray-800 border-b border-gray-700 px-4 flex items-center">
                <!-- æ—¥å¿—é¡µç­¾ä¸‹æ‹‰èœå• -->
                <div class="relative group">
                    <button :class="currentTab.startsWith('log') ? 'border-blue-500 text-white' : 'border-transparent text-gray-400 hover:text-gray-200'" class="px-4 py-3 border-b-2 font-medium text-sm transition flex items-center">
                        è¿è¡Œæ—¥å¿— <span class="ml-1 text-xs">â–¼</span>
                    </button>
                    <div class="absolute left-0 top-full bg-gray-700 rounded shadow-lg z-20 hidden group-hover:block min-w-max">
                        <button @click="currentTab = 'log_all'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_all' ? 'text-blue-400' : 'text-gray-200'">ğŸ“‹ å…¨éƒ¨æ—¥å¿—</button>
                        <button @click="currentTab = 'log_showcase'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_showcase' ? 'text-blue-400' : 'text-gray-200'">ğŸ­ å±•ç¤ºè½¦é˜Ÿ</button>
                        <button @click="currentTab = 'log_farming'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_farming' ? 'text-blue-400' : 'text-gray-200'">ğŸŒ¾ æŒ‚æœºè½¦é˜Ÿ</button>
                        <button @click="currentTab = 'log_cleanup'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_cleanup' ? 'text-blue-400' : 'text-gray-200'">ğŸ§¹ æ¸…ç†æ—¥å¿—</button>
                        <button @click="currentTab = 'log_subscribe'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_subscribe' ? 'text-blue-400' : 'text-gray-200'">ğŸ—ºï¸ è®¢é˜…æ—¥å¿—</button>
                        <button @click="currentTab = 'log_query'" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 whitespace-nowrap" :class="currentTab === 'log_query' ? 'text-blue-400' : 'text-gray-200'">ğŸ” æŸ¥è¯¢æ—¥å¿—</button>
                    </div>
                </div>
                <button @click="loadConfig('showcase')" :class="currentTab === 'config_showcase' ? 'border-blue-500 text-white' : 'border-transparent text-gray-400 hover:text-gray-200'" class="px-4 py-3 border-b-2 font-medium text-sm transition">å±•ç¤ºé…ç½®</button>
                <button @click="loadConfig('farming')" :class="currentTab === 'config_farming' ? 'border-blue-500 text-white' : 'border-transparent text-gray-400 hover:text-gray-200'" class="px-4 py-3 border-b-2 font-medium text-sm transition">æŒ‚æœºé…ç½®</button>
            </div>

            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="flex-1 bg-gray-900 overflow-hidden relative">
                
                <!-- æ—¥å¿— Tab -->
                <div v-show="currentTab.startsWith('log')" class="h-full flex flex-col p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-sm font-semibold text-gray-400">{{ logTabTitle }}</h2>
                        <button @click="clearCurrentLogs" class="text-xs text-gray-500 hover:text-white">æ¸…ç©ºæ—¥å¿—</button>
                    </div>
                    
                    <!-- Stats å›ºå®šæ˜¾ç¤ºåŒºï¼ˆä»…æŒ‚æœºæ—¥å¿—ï¼‰ -->
                    <div v-if="currentTab === 'log_farming' && farmingStats" class="bg-gray-800 border border-blue-500/50 rounded p-3 mb-2 text-sm">
                        <div class="flex items-center">
                            <span class="text-blue-400 font-bold mr-2">ğŸ“Š å®æ—¶çŠ¶æ€</span>
                            <span class="text-gray-300">{{ farmingStats }}</span>
                        </div>
                    </div>
                    
                    <div ref="logContainer" class="log-window rounded border border-gray-700 flex-1 p-2">
                        <div v-for="(log, idx) in filteredLogs" :key="idx" class="log-entry" :class="`log-${log.type}`">
                            <span class="opacity-50">[{{ log.timestamp }}]</span>
                            <span class="font-bold mx-1">[{{ log.source }}]</span>
                            <span v-html="formatMessage(log.message)"></span>
                        </div>
                    </div>
                </div>

                <!-- é…ç½® Tab -->
                <div v-show="currentTab.startsWith('config')" class="h-full flex flex-col p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-sm font-semibold text-gray-400">
                            {{ currentTab === 'config_showcase' ? 'config_showcase.json' : 'config_farming.json' }}
                        </h2>
                        <div class="space-x-2">
                            <span v-if="saveMessage" class="text-xs text-green-500">{{ saveMessage }}</span>
                            <button @click="saveConfig()" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded">ä¿å­˜ä¿®æ”¹</button>
                        </div>
                    </div>
                    <textarea v-model="configContent" class="flex-1 bg-gray-800 border border-gray-700 rounded p-4 font-mono text-sm resize-none focus:outline-none focus:border-blue-500"></textarea>
                </div>

            </div>
        </div>

        <!-- Steam Guard éªŒè¯ç å¼¹çª— -->
        <div v-if="steamGuardVisible" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50" @click.self="cancelSteamGuard">
            <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl border border-gray-700">
                <h3 class="text-lg font-semibold text-white mb-4">ğŸ” Steam Guard éªŒè¯</h3>
                <p class="text-sm text-gray-400 mb-4">éœ€è¦éªŒè¯ç  ({{ steamGuardDomain }})</p>
                <input 
                    v-model="steamGuardCode" 
                    @keyup.enter="submitSteamGuard"
                    type="text" 
                    placeholder="è¯·è¾“å…¥éªŒè¯ç "
                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white mb-4 focus:outline-none focus:border-blue-500"
                    autofocus
                >
                <div class="flex space-x-2">
                    <button @click="submitSteamGuard" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-medium transition">æäº¤</button>
                    <button @click="cancelSteamGuard" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded font-medium transition">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
        const socket = io();

        createApp({
            setup() {
                const status = ref({ showcase: false, farming: false });
                const toolStatus = ref({ running: false, name: null });
                const logs = ref([]);
                const currentTab = ref('log_all');
                const logContainer = ref(null);
                const farmingStats = ref(null); // æŒ‚æœºè½¦é˜Ÿå®æ—¶çŠ¶æ€
                
                // é…ç½®ç¼–è¾‘
                const configContent = ref('');
                const currentConfigType = ref(null);
                const saveMessage = ref('');

                // å·¥å…·å‚æ•°
                const searchGameId = ref('');
                const queryGameId = ref('');

                // é¢†é˜Ÿåˆ—è¡¨
                const showcaseLeaders = ref([]);
                const farmingLeaders = ref([]);
                const selectedShowcaseLeader = ref('');
                const selectedFarmingLeader = ref('');

                // Steam Guard éªŒè¯ç 
                const steamGuardVisible = ref(false);
                const steamGuardDomain = ref('');
                const steamGuardCode = ref('');
                const steamGuardKey = ref('');

                // è‡ªåŠ¨æ»šåŠ¨æ—¥å¿—
                const scrollToBottom = () => {
                    nextTick(() => {
                        if (logContainer.value) {
                            logContainer.value.scrollTop = logContainer.value.scrollHeight;
                        }
                    });
                };

                // æ—¥å¿—é¡µç­¾æ ‡é¢˜
                const logTabTitle = computed(() => {
                    const titles = {
                        'log_all': 'ğŸ“‹ å…¨éƒ¨æ—¥å¿—',
                        'log_showcase': 'ğŸ­ å±•ç¤ºè½¦é˜Ÿæ—¥å¿—',
                        'log_farming': 'ğŸŒ¾ æŒ‚æœºè½¦é˜Ÿæ—¥å¿—',
                        'log_cleanup': 'ğŸ§¹ æ¸…ç†æ—¥å¿—',
                        'log_subscribe': 'ğŸ—ºï¸ è®¢é˜…æ—¥å¿—',
                        'log_query': 'ğŸ” æŸ¥è¯¢æ—¥å¿—'
                    };
                    return titles[currentTab.value] || 'ç³»ç»Ÿæ—¥å¿—';
                });

                // è¿‡æ»¤æ—¥å¿—
                const filteredLogs = computed(() => {
                    const tab = currentTab.value;
                    if (tab === 'log_all') return logs.value;
                    
                    return logs.value.filter(log => {
                        const src = log.source.toLowerCase();
                        const msg = log.message.toLowerCase();
                        switch (tab) {
                            case 'log_showcase':
                                // å±•ç¤ºè½¦é˜Ÿï¼šåŒ…æ‹¬ showcase å’Œ showcase-cleanup
                                return src === 'showcase' || src === 'showcase-cleanup' ||
                                       (src === 'system' && msg.includes('showcase'));
                            case 'log_farming':
                                // æŒ‚æœºè½¦é˜Ÿï¼šåŒ…æ‹¬ farming å’Œ farming-cleanup
                                return src === 'farming' || src === 'farming-cleanup' ||
                                       (src === 'system' && msg.includes('farming'));
                            case 'log_cleanup':
                                // æ¸…ç†æ—¥å¿—ï¼šåªæ˜¾ç¤ºã€Œæ¸…ç†æ‰€æœ‰è¿›ç¨‹ã€çš„æ—¥å¿—
                                return src === 'clear_all' || src === 'clear-all' ||
                                       (src === 'system' && msg.includes('æ¸…ç†æ‰€æœ‰'));
                            case 'log_subscribe':
                                return src === 'subscribe' || src === 'subscribe_map' ||
                                       (src === 'system' && msg.includes('è®¢é˜…'));
                            case 'log_query':
                                return src === 'tool' || src === 'list_lobbies' ||
                                       (src === 'system' && msg.includes('æŸ¥è¯¢'));
                            default:
                                return true;
                        }
                    });
                });

                // æ¸…ç©ºå½“å‰é¡µç­¾æ—¥å¿—
                const clearCurrentLogs = () => {
                    if (currentTab.value === 'log_all') {
                        logs.value = [];
                    } else {
                        // åªä¿ç•™ä¸å±äºå½“å‰é¡µç­¾çš„æ—¥å¿—
                        logs.value = logs.value.filter(log => !filteredLogs.value.includes(log));
                    }
                };

                // æ ¼å¼åŒ–æ—¥å¿—æ¶ˆæ¯
                const formatMessage = (msg) => {
                    // è¯†åˆ«æ–‡ä»¶é“¾æ¥æ ‡è®°
                    if (msg.includes('[FILE_LINK]')) {
                        const filepath = msg.replace('[FILE_LINK]', '').trim();
                        const filename = filepath.split('\\').pop();
                        return `ç»“æœå·²ä¿å­˜åˆ°: <a href="/api/csv/${filename}" target="_blank" class="text-blue-400 hover:text-blue-300 underline">${filename}</a> ğŸ“¥`;
                    }
                    return msg.replace(/\n/g, '<br>');
                };

                // Socket ç›‘å¬
                onMounted(() => {
                    socket.on('log', (log) => {
                        logs.value.push(log);
                        if (logs.value.length > 1000) logs.value.shift();
                        scrollToBottom();
                        
                        // æå–æŒ‚æœºè½¦é˜Ÿ Stats ä¿¡æ¯
                        if (log.source === 'farming' && log.message.includes('[Stats]')) {
                            farmingStats.value = log.message.replace(/\[Stats\]\s*/, '').trim();
                        }
                        
                        // è½¦é˜Ÿåœæ­¢/æ¸…ç†å®Œæˆæ—¶ï¼Œæ¸…ç©º Stats
                        if (log.message.includes('è½¦é˜Ÿæ¸…ç†å®Œæˆ') || 
                            log.message.includes('è¿›ç¨‹å·²å®Œå…¨åœæ­¢') ||
                            log.message.includes('farming è¿›ç¨‹å·²é€€å‡º')) {
                            farmingStats.value = null;
                        }
                    });

                    socket.on('status', (newStatus) => {
                        status.value = { ...status.value, ...newStatus };
                        // æŒ‚æœºè½¦é˜Ÿåœæ­¢æ—¶ï¼Œæ¸…ç©º Stats
                        if (newStatus.farming === false) {
                            farmingStats.value = null;
                        }
                    });
                    
                    socket.on('toolStatus', (newToolStatus) => {
                        toolStatus.value = newToolStatus;
                    });

                    // è·å–åˆå§‹çŠ¶æ€
                    fetch('/api/status').then(r => r.json()).then(res => {
                        status.value = { showcase: res.showcase, farming: res.farming };
                        toolStatus.value = res.tool;
                    });

                    // ç›‘å¬ Steam Guard è¯·æ±‚
                    socket.on('needSteamGuard', ({ key, domain }) => {
                        steamGuardVisible.value = true;
                        steamGuardDomain.value = domain;
                        steamGuardKey.value = key;
                        steamGuardCode.value = '';
                    });

                    // åŠ è½½é¢†é˜Ÿåˆ—è¡¨
                    loadLeaders();
                });

                // API è°ƒç”¨
                const toggleProcess = async (name, action) => {
                    // åˆ‡æ¢åˆ°å¯¹åº”è½¦é˜Ÿçš„æ—¥å¿—é¡µç­¾ï¼ˆå¯åŠ¨å’Œåœæ­¢éƒ½åœ¨åŒä¸€ä¸ªé¡µç­¾ï¼‰
                    currentTab.value = name === 'showcase' ? 'log_showcase' : 'log_farming';
                    try {
                        await fetch(`/api/process/${name}/${action}`, { method: 'POST' });
                    } catch (e) {
                        logs.value.push({ timestamp: '', source: 'System', message: `API Error: ${e.message}`, type: 'error' });
                    }
                };

                const runTool = async (name, body = {}) => {
                    // æ ¹æ®å·¥å…·ç±»å‹åˆ‡æ¢åˆ°å¯¹åº”æ—¥å¿—é¡µç­¾
                    if (name === 'clear_all') {
                        currentTab.value = 'log_cleanup';
                    } else if (name === 'subscribe_map') {
                        currentTab.value = 'log_subscribe';
                    } else if (name === 'list_lobbies') {
                        currentTab.value = 'log_query';
                    } else {
                        currentTab.value = 'log_all';
                    }
                    try {
                        const res = await fetch(`/api/tool/${name}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });
                        if (!res.ok) {
                            const err = await res.json();
                            alert('æ“ä½œå¤±è´¥: ' + err.error);
                        }
                    } catch (e) {
                        alert('è¯·æ±‚å¤±è´¥');
                    }
                };

                const loadLeaders = async () => {
                    try {
                        // åŠ è½½å±•ç¤ºè½¦é˜Ÿé¢†é˜Ÿ
                        const showcaseRes = await fetch('/api/config/showcase');
                        const showcaseData = await showcaseRes.json();
                        showcaseLeaders.value = showcaseData.showcase_leaders || [];
                        
                        // åŠ è½½æµ‹è¯•é¡¹ç›® ID
                        if (showcaseData.global_settings && showcaseData.global_settings.custom_game_id) {
                            queryGameId.value = showcaseData.global_settings.custom_game_id;
                        }

                        // åŠ è½½æŒ‚æœºè½¦é˜Ÿé¢†é˜Ÿ
                        const farmingRes = await fetch('/api/config/farming');
                        const farmingData = await farmingRes.json();
                        farmingLeaders.value = (farmingData.fleets || []).map(f => f.leader).filter(l => l);
                    } catch (e) {
                        console.error('åŠ è½½é¢†é˜Ÿåˆ—è¡¨å¤±è´¥', e);
                    }
                };

                const verifyLeader = async (type, username) => {
                    if (!username) return;
                    // åˆ‡æ¢åˆ°å¯¹åº”è½¦é˜Ÿçš„æ—¥å¿—é¡µç­¾
                    currentTab.value = type === 'showcase' ? 'log_showcase' : 'log_farming';
                    try {
                        const res = await fetch(`/api/tool/login_leader`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ type, username })
                        });
                        if (!res.ok) {
                            const err = await res.json();
                            alert('æ“ä½œå¤±è´¥: ' + err.error);
                        }
                    } catch (e) {
                        alert('è¯·æ±‚å¤±è´¥');
                    }
                };

                const submitSteamGuard = () => {
                    if (!steamGuardCode.value.trim()) {
                        alert('è¯·è¾“å…¥éªŒè¯ç ');
                        return;
                    }
                    socket.emit('submitSteamGuard', { 
                        key: steamGuardKey.value, 
                        code: steamGuardCode.value.trim() 
                    });
                    steamGuardVisible.value = false;
                };

                const cancelSteamGuard = () => {
                    steamGuardVisible.value = false;
                };

                const loadConfig = async (type) => {
                    currentTab.value = `config_${type}`;
                    currentConfigType.value = type;
                    saveMessage.value = '';
                    try {
                        const res = await fetch(`/api/config/${type}`);
                        const data = await res.json();
                        configContent.value = JSON.stringify(data, null, 2);
                    } catch (e) {
                        configContent.value = '// åŠ è½½å¤±è´¥';
                    }
                };

                const saveConfig = async () => {
                    try {
                        const json = JSON.parse(configContent.value);
                        const res = await fetch(`/api/config/${currentConfigType.value}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(json)
                        });
                        
                        if (res.ok) {
                            saveMessage.value = 'ä¿å­˜æˆåŠŸ!';
                            setTimeout(() => saveMessage.value = '', 3000);
                        } else {
                            alert('ä¿å­˜å¤±è´¥');
                        }
                    } catch (e) {
                        alert('JSON æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥');
                    }
                };

                return {
                    status, toolStatus, logs, currentTab, logContainer,
                    toggleProcess, runTool, formatMessage,
                    configContent, loadConfig, saveConfig, saveMessage,
                    searchGameId, queryGameId,
                    showcaseLeaders, farmingLeaders, selectedShowcaseLeader, selectedFarmingLeader,
                    loadLeaders, verifyLeader,
                    steamGuardVisible, steamGuardDomain, steamGuardCode, 
                    submitSteamGuard, cancelSteamGuard,
                    // æ—¥å¿—é¡µç­¾ç›¸å…³
                    logTabTitle, filteredLogs, clearCurrentLogs, farmingStats
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
