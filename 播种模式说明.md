# 🌱 播种模式使用说明 (事件驱动版)

## 什么是播种模式？

**播种模式（Seeding Mode）** 是为了解决 "能创建房间的大号太少" 而设计的高效方案。

### 核心原理（事件驱动，无需等待时间）
1. **1 个大号（Leader）** 创建房间 #1，进入等待状态。
2. **小号（Follower）** 按序号从小到大扫描，找到第一个未满的房间（优先 #1）。
3. **一旦有小号加入**，大号立即检测到人数变化。
4. **大号立即退出**房间（房主转移给小号），并立即创建下一个房间 #2。
5. **循环往复**，大号不断创建新房间，小号依次填满。

---

## 配置说明

### 1. `config.json` 配置项

```json
{
  "global_settings": {
    "seeding_mode": true,              // 是否启用播种模式
    "max_players_per_room": 4          // 每个房间的人数上限
  },
  "fleets": [
    {
      "id": "fleet_1",
      "leader": {                       // 唯一的大号（车头）
        "username": "大号账号",
        "password": "密码",
        "shared_secret": ""
      },
      "followers": [                    // 所有小号（乘客）
        { "username": "小号1", "password": "...", "shared_secret": "" },
        { "username": "小号2", "password": "...", "shared_secret": "" },
        { "username": "小号3", "password": "...", "shared_secret": "" }
        // 可以添加更多小号...
      ]
    }
  ]
}
```

### 2. 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `seeding_mode` | 是否启用播种模式 | false |
| `max_players_per_room` | 每个房间的最大人数 | 4 |
| `debug_mode` | 是否启用调试模式 | false |
| `debug_max_bots_per_room` | 调试模式下每个房间最多几个Bot | 3 |

**调试模式说明**：
- 开启后，小号加入房间时，会在人数达到 `debug_max_bots_per_room` 时自动跳过该房间。
- 例如设置为 `3`，则每个房间最多只会有 3 个 Bot，**给你留一个位置手动进入观察**。
- 调试完成后，关闭 `debug_mode` 或设置为 `false` 即可恢复正常模式。

**无需时间参数**：新版本使用事件驱动，大号自动检测小号加入，无需配置等待时间和间隔。

---

## 使用流程

### 步骤 1：登录大号

```bash
node login_leader.js 1
```

按提示输入 Steam 验证码，登录成功后凭证会保存。

### 步骤 2：启动脚本

```bash
node index.js
```

### 预期输出

```
[xiaoyanxiansheng1|LEADER] 🌱 播种模式启动：将持续创建房间...
[xiaoyanxiansheng1|LEADER] 🌱 [播种 1] 创建房间: Bot Room fleet_1 #1 - 等待小号加入...

[小号1|FOLLOWER] 🔍 轮询房间列表，寻找车队 [fleet_1] 的房间...
[小号1|FOLLOWER] ✅ 找到可用房间: Bot Room fleet_1 #1 (1/4)
[小号1|FOLLOWER] ✅ 加入房间成功

[xiaoyanxiansheng1|LEADER] 👥 检测到小号加入 (1 -> 2)，立即离开并创建新房间...
[xiaoyanxiansheng1|LEADER] 🌱 [播种 2] 创建房间: Bot Room fleet_1 #2 - 等待小号加入...

[小号2|FOLLOWER] ✅ 找到可用房间: Bot Room fleet_1 #1 (2/4)
[小号2|FOLLOWER] ✅ 加入房间成功

[小号3|FOLLOWER] ✅ 找到可用房间: Bot Room fleet_1 #1 (3/4)
[小号3|FOLLOWER] ✅ 加入房间成功

[小号4|FOLLOWER] ✅ 找到可用房间: Bot Room fleet_1 #2 (1/4)
[小号4|FOLLOWER] ✅ 加入房间成功

[xiaoyanxiansheng1|LEADER] 👥 检测到小号加入 (1 -> 2)，立即离开并创建新房间...
[xiaoyanxiansheng1|LEADER] 🌱 [播种 3] 创建房间: Bot Room fleet_1 #3 - 等待小号加入...
...
```

---

## 工作流程图

```
大号 (Leader):
  创建房间 #1 → 等待小号加入 → 检测到人数+1 → 立即离开 → 立即创建房间 #2 → ...

小号 (Followers):
  轮询列表 → 找到 #1（未满）→ 加入 → 停止轮询
  轮询列表 → #1 已满，找到 #2（未满）→ 加入 → 停止轮询
  轮询列表 → #1、#2 已满，找到 #3（未满）→ 加入 → 停止轮询
  ...
```

**关键点**：
- 小号**按序号从小到大**寻找未满房间，确保先填满 #1，再填 #2...
- 大号**实时检测**人数变化，一旦有人加入就触发创建下一个房间。
- **零等待**，完全事件驱动。

---

## 常见问题

### Q1: 房间满了怎么办？
**A:** 小号会自动跳过满人的房间，按序号从小到大寻找第一个未满房间（如 #1 满了就去 #2）。

### Q2: 大号会不会创建太快，导致 Steam 封禁？
**A:** 不会。大号是**事件驱动**的，只有在小号加入后才创建下一个房间，自然就有间隔。

### Q3: 如果大号退出后，房间解散了怎么办？
**A:** 说明游戏机制不支持房主转移。请手动测试确认后再启用播种模式。

### Q4: 可以同时用多个大号吗？
**A:** 可以！只需配置多个 `fleets`，每个车队独立运行。

### Q5: 调试模式有什么用？
**A:** 开启调试模式后，每个房间会给你预留一个观察位（例如房间上限 4 人，Bot 只会填 3 个）。这样你可以手动进入房间，查看 Bot 的状态、行为是否正常。调试完成后关闭即可。

### Q6: 如何停止脚本？
**A:** 按 `Ctrl+C`，脚本会自动清理所有 Bot 并退出。

---

## 优势总结

✅ **1 个大号，无限开房**  
✅ **小号自动分配到各个房间**  
✅ **避免账号权限问题（小号不需要创建权限）**  
✅ **可扩展：添加更多小号即可**  

---

## 技术细节

- 房间名称格式：`Bot Room fleet_1 #1`, `Bot Room fleet_1 #2`, ...
- 小号通过房间名称的车队 ID 识别目标房间。
- 小号**按序号从小到大**加入未满房间（优先填满编号小的房间）。
- 大号通过监听 `Lobby Snapshot (7004)` 消息的 `members.length` 字段检测人数变化。
- 一旦检测到人数增加，大号立即离开并创建下一个房间（无延迟）。
- 加入成功后，小号停止轮询，保持在房间内挂机。

## 性能优势

✅ **零等待**：完全事件驱动，无需配置时间参数  
✅ **按序填充**：确保房间按 #1, #2, #3... 顺序填满  
✅ **自然间隔**：大号只在有小号加入时才创建新房间，不会触发反作弊  
✅ **高效利用**：每个房间填满后才创建下一个，资源利用率最高

---

**祝您挂机顺利！🚀**

