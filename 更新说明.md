# Dota 2 街机机器人 - 自动接受匹配更新

## 📋 更新内容

### v6.18 - 2025-01-22
**新增功能：自动设置队伍位置 + 自动接受匹配**

---

## 🎯 解决的问题

### 原问题
- Bot成功加入房间，但显示为**灰色问号**（未选择队伍）
- 房主点击"开始比赛"后，Bot无法响应接受匹配
- 导致游戏无法正常开始，在线人数无法正确统计

### 解决方案
1. ✅ Bot加入房间后自动设置队伍位置（加入天辉队）
2. ✅ Bot监听房主发起的匹配请求（消息ID: 7170）
3. ✅ 收到匹配请求后自动发送"接受"响应

---

## 🔧 具体修改

### 1. 新增消息常量
```javascript
const k_EMsgGCReadyUpStatus = 7170;  // 准备就绪状态更新（房主发起匹配时）
```

### 2. 自动设置队伍位置
Bot加入房间后的流程：
```
步骤1: 发送 SetTeamSlot (7047) → 加入天辉队第一个位置
   ↓ (等待500ms)
步骤2: 发送 ReadyUp (7070) → 标记为"已准备"
```

### 3. 自动接受匹配
当收到消息`7170 (ReadyUpStatus)`时：
```
房主点击"开始比赛"
   ↓
Bot收到 ReadyUpStatus (7170)
   ↓ (等待200ms)
Bot自动发送 ReadyUp (READY)
   ↓
游戏开始！
```

---

## 🚀 使用方法

### 1. 重新启动Bot
```bash
node index.js
```

### 2. 预期日志输出
```
[账号] ✅ 成功直接加入房间！
[账号] 📤 设置队伍位置 (7047) - 加入天辉队
[账号] 📤 发送 ReadyUp (7070) - state=READY
[账号] ✅ Bot 已标记为"准备就绪"状态

# 当房主点击"开始比赛"时
[账号] 🚨 收到 ReadyUp 状态更新 (7170) - 房主可能点击了"开始比赛"！
[账号] ✅ 自动接受匹配 - 发送 ReadyUp (READY)
```

### 3. 游戏界面效果
- Bot现在会显示为**绿色头像**（已选择队伍并准备）
- 房主点击"开始比赛"后，Bot会自动接受
- 游戏正常开始，在线人数正确统计

---

## 📊 核心目标：增加游廊在线人数

### 原理说明
1. **显示在线人数的条件**：
   - 玩家必须在Lobby房间中
   - 玩家必须选择了队伍位置（不是旁观者）
   - 玩家必须标记为"已准备"状态

2. **Bot现在满足所有条件**：
   - ✅ 成功加入房间（CMsgPracticeLobbyJoin）
   - ✅ 设置队伍位置（CMsgPracticeLobbySetTeamSlot）
   - ✅ 标记为已准备（CMsgReadyUp）
   - ✅ 自动响应匹配请求（CMsgReadyUp响应）

3. **在线人数计算**：
   - 游廊项目页面显示的"正在游戏"人数包括：
     - 所有在Lobby中选择队伍的玩家
     - 所有正在进行游戏的玩家
   - Bot现在可以被正确计入统计

---

## 🎮 多账号批量运行

### config.json 配置示例
```json
{
  "cluster_settings": {
    "target_app_id": 570,
    "concurrency": 1,
    "custom_game_id": "你的游戏ID"
  },
  "accounts": [
    { 
      "username": "小号1", 
      "password": "密码1", 
      "shared_secret": "" 
    },
    { 
      "username": "小号2", 
      "password": "密码2", 
      "shared_secret": "" 
    },
    { 
      "username": "小号3", 
      "password": "密码3", 
      "shared_secret": "" 
    }
  ]
}
```

### 批量运行效果
- 多个Bot同时加入房间
- 每个Bot自动选择队伍位置
- 在线人数增加数量 = Bot数量
- 所有Bot会自动接受匹配

---

## ⚠️ 注意事项

### 1. 队伍位置设置
- 当前默认加入**天辉队（DOTA_GC_TEAM_GOOD_GUYS）**
- 位置固定为**第一个槽位（slot: 0）**
- 如果该位置已占用，Dota 2会自动分配其他可用位置

### 2. 房间容量限制
- Bot只能加入**未满的房间**
- 如果房间已满，Bot会自动创建新房间
- 建议房主创建房间时设置足够的玩家上限

### 3. 游戏模式兼容性
- 适用于所有自定义游戏模式
- 兼容合作模式、PVP模式、街机模式
- Bot会根据房间设置自动适配

### 4. Steam账号安全
- 建议使用小号运行Bot
- 不建议在主账号上使用
- 频繁操作可能触发Steam冷却机制

---

## 🔍 调试信息

### 关键消息ID列表
| 消息名称 | 消息ID | 说明 |
|---------|--------|------|
| PracticeLobbyJoin | 7044 | 加入房间 |
| PracticeLobbySetTeamSlot | 7047 | 设置队伍位置 |
| ReadyUp | 7070 | 标记准备/接受匹配 |
| ReadyUpStatus | 7170 | 房主发起匹配通知 |
| PracticeLobbyJoinResponse | 7113 | 加入房间响应 |
| JoinableCustomLobbiesResponse | 7469 | 可加入房间列表 |
| GameMatchSignOut | 7004 | Lobby快照（确认在房间中）|

### 测试步骤
1. 启动Bot，观察是否成功加入房间
2. 检查日志中是否有"设置队伍位置 (7047)"
3. 在游戏中查看Bot是否显示为绿色头像
4. 房主点击"开始比赛"，观察Bot是否自动接受
5. 确认游戏是否正常开始

---

## 📈 预期效果

### 游廊项目页面
- ✅ "正在游戏"人数增加
- ✅ "玩家"列表显示Bot账号
- ✅ 24小时在线人数统计增加

### 房间内效果
- ✅ Bot显示为正常玩家（绿色头像）
- ✅ Bot自动接受匹配
- ✅ 游戏可以正常开始

---

## 🐛 常见问题

### Q1: Bot显示灰色问号怎么办？
**A:** 检查日志是否有"设置队伍位置 (7047)"消息。如果没有，说明SetTeamSlot消息发送失败。

### Q2: 房主点击开始后Bot没反应？
**A:** 确认日志中是否收到"7170"消息。如果收到但没有响应，检查ReadyUp消息是否发送成功。

### Q3: Bot加入后立即掉线？
**A:** 可能是Steam账号被限制。尝试：
- 手动登录Steam客户端玩一局游戏
- 等待24小时后重试
- 更换其他小号

### Q4: 在线人数没有增加？
**A:** 确认以下条件：
- Bot是否成功加入房间（收到7113响应）
- Bot是否设置了队伍位置（发送7047）
- Bot是否标记为已准备（发送7070）
- 游廊项目统计可能有延迟（最多30分钟）

---

## 💡 优化建议

### 1. 多账号策略
- 使用5-10个小号可以明显提升在线人数显示
- 建议每个账号至少有10小时游戏时间
- 避免使用新注册账号（可能被限制）

### 2. 运行时机
- 在游戏上线初期使用，吸引真实玩家
- 在游戏更新后使用，保持活跃度
- 避免24小时持续运行（容易被检测）

### 3. 房间管理
- 定期（每2小时）重启Bot
- 避免Bot长时间停留在同一个房间
- 可以设置Bot定时离开并重新加入

---

## 📝 版本历史

### v6.18 (2025-01-22)
- ✅ 新增自动设置队伍位置功能
- ✅ 新增自动接受匹配功能
- ✅ 优化日志输出

### v6.17 (之前版本)
- ✅ 修复Proto结构问题
- ✅ 使用正确的驼峰命名
- ✅ 改进ReadyUp状态处理

---

## 🎯 总结

现在Bot已经完全自动化：
1. ✅ 自动查询房间列表
2. ✅ 自动加入或创建房间
3. ✅ 自动设置队伍位置
4. ✅ 自动标记为已准备
5. ✅ 自动接受匹配请求

**您只需要：启动脚本，然后等待Bot自动完成所有操作！**

